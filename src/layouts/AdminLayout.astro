---
import "../styles/global.css";
import MosaicBackground from "../components/ui/MosaicBackground.astro";
import { supabase } from "../lib/supabase";

interface Props {
    title: string;
    activeSection?: string;
}

const { title, activeSection = "dashboard" } = Astro.props;

// Fetch feature settings
const { data: featureSettings } = await supabase
    .from("settings")
    .select("*")
    .in("key", [
        "feature_news_enabled",
        "feature_promos_enabled",
        "feature_gallery_enabled",
        "feature_popups_enabled",
        "feature_newsletter_enabled",
    ]);

const getFeatureSetting = (key: string) => {
    const setting = featureSettings?.find((s: any) => s.key === key);
    return setting ? setting.value : true;
};

const features = {
    news: getFeatureSetting("feature_news_enabled"),
    promos: getFeatureSetting("feature_promos_enabled"),
    gallery: getFeatureSetting("feature_gallery_enabled"),
    popups: getFeatureSetting("feature_popups_enabled"),
    newsletter: getFeatureSetting("feature_newsletter_enabled"),
};

// Server-side Auth Check

const navItems = [
    { id: "dashboard", label: "Dashboard", href: "/admin", icon: "home" },
    {
        id: "products",
        label: "Productos",
        href: "/admin/products",
        icon: "package",
    },
    {
        id: "orders",
        label: "Pedidos",
        href: "/admin/orders",
        icon: "shopping-bag",
    },
    {
        id: "invoices",
        label: "Facturas",
        href: "/admin/invoices",
        icon: "invoice",
    },
    {
        id: "newsletter",
        label: "Newsletter",
        href: "/admin/newsletter",
        icon: "mail",
    },
    {
        id: "popups",
        label: "Pop-ups",
        href: "/admin/popups",
        icon: "external-link",
    },
    {
        id: "engagement",
        label: "Engagement",
        href: "/admin/engagement",
        icon: "target",
    },
    {
        id: "categories",
        label: "Categorías",
        href: "/admin/categories",
        icon: "tag",
    },
    { id: "gallery", label: "Galería", href: "/admin/gallery", icon: "image" },
    {
        id: "promos",
        label: "Promociones",
        href: "/admin/promos",
        icon: "percent",
    },
    {
        id: "news",
        label: "Noticias",
        href: "/admin/news",
        icon: "newspaper",
    },
];

// Filter navItems based on feature settings
const featureToNavIdMap: Record<string, string> = {
    news: "news",
    promos: "promos",
    gallery: "gallery",
    popups: "popups",
    newsletter: "newsletter",
};

const filteredNavItems = navItems.filter((item) => {
    const featureKey = Object.keys(featureToNavIdMap).find(
        (key) => featureToNavIdMap[key] === item.id,
    );
    if (featureKey) {
        return features[featureKey as keyof typeof features];
    }
    return true; // Keep items not related to features (dashboard, products, orders, etc.)
});
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/png" href="/logo.png" />
        <link href="https://fonts.cdnfonts.com/css/chomsky" rel="stylesheet" />
        <style is:global>
            @import url("https://fonts.cdnfonts.com/css/chomsky");
            .font-chomsky {
                font-family: "Chomsky", sans-serif !important;
            }
        </style>
        <title>{title} | Admin SLC CUTS</title>
    </head>
    <body
        class="bg-gray-900 text-white min-h-screen flex relative"
        id="adminBody"
    >
        <!-- Loading Overlay -->
        <div
            id="loadingOverlay"
            class="fixed inset-0 z-[100] bg-gray-900 flex items-center justify-center transition-opacity duration-300"
        >
            <div class="flex flex-col items-center gap-4">
                <div
                    class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin"
                >
                </div>
                <p
                    class="text-xs font-bold uppercase tracking-[0.2em] text-gray-500"
                >
                    Verificando Credenciales
                </p>
            </div>
        </div>
        <!-- Mosaic Background -->
        <MosaicBackground mode="dark" opacity="opacity-[0.03]" />

        <!-- Sidebar -->
        <aside
            id="adminSidebar"
            class="w-64 bg-black/95 backdrop-blur-md min-h-screen flex flex-col border-r border-gray-800 fixed left-0 top-0 bottom-0 z-[60] transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0"
        >
            <!-- Brand -->
            <div class="p-6 border-b border-gray-800">
                <a href="/admin" class="block text-center">
                    <span
                        class="text-4xl font-chomsky text-white hover:opacity-80 transition-opacity"
                        >@slc.cuts</span
                    >
                    <span
                        class="block text-xs text-gray-500 uppercase tracking-widest mt-2"
                        >Panel Admin</span
                    >
                </a>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 py-6">
                <ul class="space-y-1 px-3">
                    {
                        filteredNavItems.map((item) => (
                            <li>
                                <a
                                    href={item.href}
                                    class={`flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${
                                        activeSection === item.id
                                            ? "bg-white text-black font-bold"
                                            : "text-gray-400 hover:text-white hover:bg-gray-800"
                                    }`}
                                >
                                    {item.icon === "home" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                                            <polyline points="9 22 9 12 15 12 15 22" />
                                        </svg>
                                    )}
                                    {item.icon === "package" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="m7.5 4.27 9 5.15" />
                                            <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
                                            <path d="m3.3 7 8.7 5 8.7-5" />
                                            <path d="M12 22V12" />
                                        </svg>
                                    )}
                                    {item.icon === "shopping-bag" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" />
                                            <path d="M3 6h18" />
                                            <path d="M16 10a4 4 0 0 1-8 0" />
                                        </svg>
                                    )}
                                    {item.icon === "image" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <rect
                                                width="18"
                                                height="18"
                                                x="3"
                                                y="3"
                                                rx="2"
                                                ry="2"
                                            />
                                            <circle cx="9" cy="9" r="2" />
                                            <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
                                        </svg>
                                    )}
                                    {item.icon === "invoice" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                                            <path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z" />
                                            <path d="M12 11h4" />
                                            <path d="M12 16h4" />
                                            <path d="M8 11h.01" />
                                            <path d="M8 16h.01" />
                                        </svg>
                                    )}
                                    {item.icon === "mail" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <rect
                                                width="20"
                                                height="16"
                                                x="2"
                                                y="4"
                                                rx="2"
                                            />
                                            <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
                                        </svg>
                                    )}
                                    {item.icon === "external-link" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="M15 3h6v6" />
                                            <path d="M10 14 21 3" />
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                        </svg>
                                    )}
                                    {item.icon === "target" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <circle cx="12" cy="12" r="10" />
                                            <circle cx="12" cy="12" r="6" />
                                            <circle cx="12" cy="12" r="2" />
                                        </svg>
                                    )}
                                    {item.icon === "scissors" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <circle cx="6" cy="6" r="3" />
                                            <path d="M8.12 8.12 12 12" />
                                            <path d="M20 4 8.12 15.88" />
                                            <circle cx="6" cy="18" r="3" />
                                            <path d="M14.8 14.8 20 20" />
                                        </svg>
                                    )}
                                    {item.icon === "tag" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" />
                                            <path d="M7 7h.01" />
                                        </svg>
                                    )}
                                    {item.icon === "percent" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <line
                                                x1="19"
                                                x2="5"
                                                y1="5"
                                                y2="19"
                                            />
                                            <circle cx="6.5" cy="6.5" r="2.5" />
                                            <circle
                                                cx="17.5"
                                                cy="17.5"
                                                r="2.5"
                                            />
                                        </svg>
                                    )}
                                    {item.icon === "newspaper" && (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2" />
                                            <path d="M18 14h-8" />
                                            <path d="M15 18h-5" />
                                            <path d="M10 6h8v4h-8V6Z" />
                                        </svg>
                                    )}
                                    <span class="uppercase text-sm tracking-wider">
                                        {item.label}
                                    </span>
                                </a>
                            </li>
                        ))
                    }
                </ul>
            </nav>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-800 space-y-2">
                <button
                    id="logoutBtn"
                    class="w-full flex items-center gap-2 text-gray-500 hover:text-red-400 text-sm transition-colors group"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="group-hover:translate-x-1 transition-transform"
                        ><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"
                        ></path><polyline points="16 17 21 12 16 7"
                        ></polyline><line x1="21" x2="9" y1="12" y2="12"
                        ></line></svg
                    >
                    Cerrar Sesión
                </button>
                <a
                    href="/"
                    class="flex items-center gap-2 text-gray-500 hover:text-white text-sm transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"
                        ></path></svg
                    >
                    Volver a la tienda
                </a>
            </div>
        </aside>

        <!-- Sidebar Backdrop (Mobile) -->
        <div
            id="sidebarBackdrop"
            class="fixed inset-0 bg-black/60 z-50 invisible opacity-0 transition-opacity duration-300 lg:hidden"
        >
        </div>

        <script>
            import { supabase } from "../lib/supabase";

            const adminBody = document.getElementById("adminBody");
            const loadingOverlay = document.getElementById("loadingOverlay");

            // Global Error Handler for debugging
            window.onerror = function (msg, url, line, col, error) {
                console.error("Global Error:", msg, error);
                if (loadingOverlay) {
                    loadingOverlay.innerHTML = `
                        <div class="text-center p-8 text-red-500 z-50 relative">
                            <h3 class="text-xl font-bold mb-2">Error de Javascript</h3>
                            <p class="mb-4 text-xs font-mono text-left bg-black/50 p-4 rounded">${msg}</p>
                            <button onclick="location.reload()" class="bg-white text-black px-4 py-2 rounded">Recargar</button>
                        </div>
                   `;
                    loadingOverlay.classList.remove("opacity-0");
                }
                return false;
            };

            // Protection Logic
            const checkSession = async () => {
                console.log("Checking session...");
                const {
                    data: { session },
                    error: sessionError,
                } = await supabase.auth.getSession();

                console.log("Session result:", { session, sessionError });

                if (!session) {
                    console.log("No session found, redirecting to login");
                    window.location.href = "/login";
                    return;
                }

                // Double check role
                const { data: profile, error } = await supabase
                    .from("users")
                    .select("role")
                    .eq("id", session.user.id)
                    .single();

                if (
                    error ||
                    !profile ||
                    profile.role.toLowerCase().trim() !== "admin"
                ) {
                    console.error("Acceso Admin Denegado:", { error, profile });

                    // Show error UI instead of infinite loop
                    if (loadingOverlay) {
                        loadingOverlay.innerHTML = `
                            <div class="text-center p-8 text-red-500">
                                <h3 class="text-xl font-bold mb-2">Acceso Denegado</h3>
                                <p class="mb-4">Tu usuario no tiene permisos de administrador.</p>
                                <p class="text-xs text-gray-400 mb-6">Rol detectado: ${profile?.role || "Ninguno"}</p>
                                <a href="/login" class="bg-white text-black px-4 py-2 rounded font-bold uppercase text-xs tracking-widest hover:bg-gray-200">Volver al Login</a>
                            </div>
                         `;
                        // Ensure overlay is visible but stop spinning
                        loadingOverlay.classList.remove("opacity-0");
                    }
                    return;
                }

                // If everything is OK, show the content
                if (loadingOverlay) loadingOverlay.classList.add("opacity-0");
                if (adminBody) adminBody.classList.remove("opacity-0");

                setTimeout(() => {
                    if (loadingOverlay) loadingOverlay.style.display = "none";
                }, 300);
            };

            checkSession();

            // Failsafe: Remove overlay after 5 seconds if logic hangs
            setTimeout(() => {
                const overlay = document.getElementById("loadingOverlay");
                if (
                    overlay &&
                    overlay.style.display !== "none" &&
                    !overlay.innerHTML.includes("Acceso Denegado")
                ) {
                    console.warn("Failsafe triggered: Forced overlay removal");
                    overlay.style.display = "none";
                    if (adminBody) adminBody.classList.remove("opacity-0");
                }
            }, 5000);

            // Logout Logic
            document
                .getElementById("logoutBtn")
                ?.addEventListener("click", async () => {
                    await supabase.auth.signOut();
                    window.location.href = "/login";
                });

            // Sidebar Toggle Logic
            const sidebar = document.getElementById("adminSidebar");
            const backdrop = document.getElementById("sidebarBackdrop");
            const toggleBtns = document.querySelectorAll(".sidebar-toggle");

            function openSidebar() {
                sidebar?.classList.remove("-translate-x-full");
                backdrop?.classList.remove("invisible");
                backdrop?.classList.add("opacity-100");
                document.body.style.overflow = "hidden";
            }

            function closeSidebar() {
                sidebar?.classList.add("-translate-x-full");
                backdrop?.classList.remove("opacity-100");
                setTimeout(() => {
                    backdrop?.classList.add("invisible");
                }, 300);
                document.body.style.overflow = "";
            }

            toggleBtns.forEach((btn) => {
                btn.addEventListener("click", openSidebar);
            });

            backdrop?.addEventListener("click", closeSidebar);

            // Auto close on navigation
            sidebar?.querySelectorAll("a").forEach((link) => {
                link.addEventListener("click", closeSidebar);
            });

            // Global Toast Notification Logic
            (window as any).showToast = (
                title: string,
                message: string,
                type: "success" | "error" = "success",
            ) => {
                const toast = document.createElement("div");
                toast.className = `fixed bottom-4 right-4 flex items-center gap-4 px-6 py-4 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-500 z-[100] border ${
                    type === "error"
                        ? "bg-red-900/90 border-red-700 text-white"
                        : "bg-gray-800/90 border-gray-700 text-white"
                }`;

                toast.innerHTML = `
                    <div class="flex-shrink-0">
                        ${
                            type === "error"
                                ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>'
                                : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
                        }
                    </div>
                    <div>
                        <h4 class="font-bold text-sm uppercase tracking-wider">${title}</h4>
                        <p class="text-sm text-gray-300">${message}</p>
                    </div>
                    <button onclick="this.parentElement.remove()" class="ml-4 text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                `;

                document.body.appendChild(toast);

                // Animate IN
                requestAnimationFrame(() => {
                    toast.classList.remove("translate-y-20", "opacity-0");
                });

                // Auto removal
                setTimeout(() => {
                    toast.classList.add("translate-y-20", "opacity-0");
                    setTimeout(() => toast.remove(), 500);
                }, 4000);
            };
        </script>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-64 min-h-screen relative z-10 w-full">
            <!-- Top Bar -->
            <header
                class="bg-gray-900/80 backdrop-blur-sm border-b border-gray-700 px-4 md:px-8 py-4 sticky top-0 z-40 flex items-center justify-between"
            >
                <div class="flex items-center gap-4">
                    <button
                        class="sidebar-toggle p-2 text-gray-400 hover:text-white transition-colors lg:hidden -ml-2"
                        aria-label="Abrir menú"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="lucide lucide-menu"
                            ><line x1="4" x2="20" y1="12" y2="12"></line><line
                                x1="4"
                                x2="20"
                                y1="6"
                                y2="6"></line><line
                                x1="4"
                                x2="20"
                                y1="18"
                                y2="18"></line></svg
                        >
                    </button>
                    <h1
                        class="text-xl md:text-2xl font-bold uppercase tracking-wider truncate"
                    >
                        {title}
                    </h1>
                </div>

                <div class="flex items-center gap-3">
                    <a
                        href="/"
                        class="p-2 text-gray-400 hover:text-white transition-colors"
                        title="Ver Tienda"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="lucide lucide-external-link"
                            ><path d="M15 3h6v6"></path><path d="M10 14 21 3"
                            ></path><path
                                d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"
                            ></path></svg
                        >
                    </a>
                </div>
            </header>

            <!-- Page Content -->
            <div class="p-4 md:p-8">
                <slot />
            </div>
        </main>
    </body>
</html>
