---
import "../styles/global.css";
import { supabase } from "../lib/supabase";
import MosaicBackground from "../components/ui/MosaicBackground.astro";
import ProductModal from "../components/ui/ProductModal";
import CartDrawer from "../components/cart/CartDrawer";

interface Props {
    title: string;
}

const { title } = Astro.props;

// Fetch global settings for menu visibility (Server Side)
const { data: settings } = await supabase
    .from("settings")
    .select("value")
    .eq("key", "flash_offers_enabled")
    .single();

const showFlashOffers = settings?.value ?? false;
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="description"
            content="SLC CUTS - Barbería de Autor & Tienda Online de Productos Premium. Estilo, maestría y vanguardia en Chipiona."
        />
        <meta
            name="keywords"
            content="barberia, peluqueria, chipiona, slc cuts, productos capilares, nishman, cera pelo, barber shop cadiz"
        />
        <meta name="viewport" content="width=device-width" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={Astro.url} />
        <meta property="og:title" content={`${title} | SLC CUTS`} />
        <meta
            property="og:description"
            content="SLC CUTS - Barbería de Autor & Tienda Online de Productos Premium. Estilo, maestría y vanguardia."
        />
        <meta property="og:image" content={new URL("/logo.png", Astro.url)} />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={Astro.url} />
        <meta property="twitter:title" content={`${title} | SLC CUTS`} />
        <meta
            property="twitter:description"
            content="SLC CUTS - Barbería de Autor & Tienda Online de Productos Premium."
        />
        <meta
            property="twitter:image"
            content={new URL("/logo.png", Astro.url)}
        />

        <link rel="icon" type="image/png" href="/logo.png" />
        <link href="https://fonts.cdnfonts.com/css/chomsky" rel="stylesheet" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@100..900&display=swap"
            rel="stylesheet"
        />
        <style is:global>
            @import url("https://fonts.cdnfonts.com/css/chomsky");

            @font-face {
                font-family: "DarkCastleLocal";
                src: url("/fonts/Darkcastle_PERSONAL_USE_ONLY.otf")
                    format("opentype");
                font-weight: normal;
                font-style: normal;
            }

            .font-chomsky {
                font-family: "Chomsky", sans-serif !important;
            }
            .font-darkcastle {
                font-family: "DarkCastleLocal", sans-serif !important;
                font-weight: normal !important;
            }
            .font-outfit {
                font-family: "Outfit", sans-serif !important;
            }
            .font-bebas {
                font-family: "Bebas Neue", sans-serif !important;
            }
        </style>
        <meta name="generator" content={Astro.generator} />
        <title>{title}</title>
    </head>
    <body
        class="bg-gray-50 text-gray-900 font-sans antialiased min-h-screen flex flex-col relative"
    >
        <!-- Noise Texture Overlay -->
        <div
            class="fixed inset-0 z-50 pointer-events-none opacity-[0.03] mix-blend-overlay"
            style="background-image: url('https://grainy-gradients.vercel.app/noise.svg');"
        >
        </div>

        <!-- Header will go here -->
        <header
            class="bg-white sticky top-0 z-50 shadow-md border-b border-gray-100"
        >
            <nav
                class="container mx-auto px-4 h-20 flex items-center justify-between"
            >
                <!-- Logo -->
                <a href="/" class="flex-shrink-0">
                    <span
                        class="text-5xl hover:opacity-80 transition-opacity text-black tracking-widest lowercase font-chomsky"
                        >@slc.cuts</span
                    >
                </a>

                <!-- Desktop Menu -->
                <div
                    class="hidden md:flex items-center gap-8 text-sm font-bold tracking-widest uppercase text-gray-900"
                >
                    <a
                        href="/shop/new"
                        class="hover:text-gray-600 transition-colors"
                        >Productos</a
                    >
                    <a
                        href="/gallery"
                        class="hover:text-gray-600 transition-colors">Galería</a
                    >
                    <a
                        href="/news"
                        class="hover:text-gray-600 transition-colors"
                        >Noticias</a
                    >
                    <a
                        href="/services"
                        class="bg-black text-white px-6 py-3 rounded-lg text-xs md:text-sm font-bold uppercase tracking-widest hover:bg-gray-800 transition-colors"
                    >
                        Reservar Cita
                    </a>
                    <a
                        href="/shop/offers"
                        class="text-red-600 hover:text-red-700 transition-colors animate-pulse"
                        style={showFlashOffers ? "" : "display: none"}
                        >Ofertas</a
                    >
                </div>

                <!-- Icons -->
                <div class="flex items-center gap-6 text-gray-900">
                    <a
                        href="/contact"
                        class="hover:text-gray-600 transition-colors"
                        aria-label="Contacto"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="22"
                            height="22"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="lucide lucide-phone"
                            ><path
                                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                            ></path></svg
                        >
                    </a>
                    <button
                        id="header-cart-btn"
                        class="relative hover:text-gray-600 transition-colors"
                    >
                        <span class="sr-only">Carrito</span>
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="22"
                            height="22"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="lucide lucide-shopping-bag"
                            ><path
                                d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"
                            ></path><path d="M3 6h18"></path><path
                                d="M16 10a4 4 0 0 1-8 0"></path></svg
                        >
                        <!-- Cart Badge -->
                        <span
                            id="cart-badge"
                            class="absolute -top-2 -right-2 bg-black text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden"
                        >
                            0
                        </span>
                    </button>
                    <script>
                        import {
                            openCart,
                            cartStore,
                        } from "../store/cartStore";

                        const cartBtn =
                            document.getElementById("header-cart-btn");
                        const cartBadge = document.getElementById("cart-badge");

                        // Update badge count
                        function updateCartBadge() {
                            const state = cartStore.get();
                            const totalItems = state.items.reduce(
                                (sum, item) => sum + item.quantity,
                                0,
                            );

                            if (cartBadge) {
                                if (totalItems > 0) {
                                    cartBadge.textContent =
                                        totalItems.toString();
                                    cartBadge.classList.remove("hidden");
                                } else {
                                    cartBadge.classList.add("hidden");
                                }
                            }
                        }

                        // Initial update
                        updateCartBadge();

                        // Subscribe to cart changes
                        cartStore.subscribe(updateCartBadge);

                        // Open cart on click
                        cartBtn?.addEventListener("click", () => {
                            openCart();
                        });
                    </script>
                </div>
            </nav>
        </header>

        <main class="flex-grow">
            <slot />
        </main>

        <footer
            class="bg-gray-950 text-white py-12 mt-auto relative overflow-hidden"
        >
            <MosaicBackground mode="dark" opacity="opacity-5" />
            <div
                class="container mx-auto px-4 grid md:grid-cols-4 gap-8 relative z-10"
            >
                <div>
                    <h3
                        class="text-xl font-bold mb-4 font-chomsky tracking-widest text-2xl"
                    >
                        @slc.cuts
                    </h3>
                    <p class="text-gray-400 text-sm">
                        Estilo, precisión y tradición en cada corte.
                    </p>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Explorar</h4>
                    <ul class="text-sm text-gray-400 space-y-2">
                        <li>
                            <a
                                href="/shop/new"
                                class="hover:text-white transition-colors"
                                >Novedades</a
                            >
                        </li>
                        <li>
                            <a
                                href="/shop/offers"
                                class="hover:text-white transition-colors"
                                >Ofertas</a
                            >
                        </li>
                        <li>
                            <a
                                href="/gallery"
                                class="hover:text-white transition-colors"
                                >Galería</a
                            >
                        </li>
                        <li>
                            <a
                                href="/news"
                                class="hover:text-white transition-colors"
                                >Blog</a
                            >
                        </li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Contacto</h4>
                    <ul class="text-sm text-gray-400 space-y-2">
                        <li>
                            <a
                                href="tel:+34722108440"
                                class="hover:text-white transition-colors flex items-center gap-2"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                                    ></path></svg
                                >
                                +34 722 10 84 40
                            </a>
                        </li>
                        <li>
                            <a
                                href="mailto:slccuts1998@gmail.com"
                                class="hover:text-white transition-colors flex items-center gap-2"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        width="20"
                                        height="16"
                                        x="2"
                                        y="4"
                                        rx="2"></rect><path
                                        d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"
                                    ></path></svg
                                >
                                slccuts1998@gmail.com
                            </a>
                        </li>
                        <li>
                            <a
                                href="https://wa.me/34722108440"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="hover:text-white transition-colors flex items-center gap-2"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"
                                    ></path></svg
                                >
                                WhatsApp
                            </a>
                        </li>
                        <li>
                            <a
                                href="https://instagram.com/slc.cuts"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="hover:text-white transition-colors flex items-center gap-2"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        width="20"
                                        height="20"
                                        x="2"
                                        y="2"
                                        rx="5"
                                        ry="5"></rect><path
                                        d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"
                                    ></path><line
                                        x1="17.5"
                                        x2="17.51"
                                        y1="6.5"
                                        y2="6.5"></line></svg
                                >
                                Instagram
                            </a>
                        </li>
                        <li class="pt-2">
                            <p class="text-xs text-gray-500">
                                C. Miguel de Cervantes, 79<br />11550 Chipiona
                            </p>
                        </li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Legal</h4>
                    <ul class="text-sm text-gray-400 space-y-2">
                        <li>
                            <a
                                href="/privacy"
                                class="hover:text-white transition-colors"
                                >Política de Privacidad</a
                            >
                        </li>
                        <li>
                            <a
                                href="/terms"
                                class="hover:text-white transition-colors"
                                >Términos y Condiciones</a
                            >
                        </li>
                        <li>
                            <a
                                href="/faq"
                                class="hover:text-white transition-colors"
                                >Preguntas Frecuentes</a
                            >
                        </li>
                        <li class="pt-2">
                            <a
                                href="/login"
                                class="hover:text-white transition-colors flex items-center gap-2 group"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="group-hover:text-indigo-400 transition-colors"
                                    ><rect
                                        width="18"
                                        height="11"
                                        x="3"
                                        y="11"
                                        rx="2"
                                        ry="2"></rect><path
                                        d="M7 11V7a5 5 0 0 1 10 0v4"
                                    ></path></svg
                                >
                                Acceso Admin
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <div
                class="container mx-auto px-4 mt-12 pt-8 border-t border-gray-900 relative z-10 text-center"
            >
                <p class="text-xs text-gray-600 mb-2">
                    &copy; {new Date().getFullYear()} SLC CUTS. Todos los derechos
                    reservados.
                </p>
                <div class="mt-4">
                    <p
                        class="text-xs font-medium tracking-wide text-transparent bg-clip-text bg-gradient-to-r from-gray-500 via-white to-gray-500 animate-shimmer bg-[length:200%_auto]"
                    >
                        Pagina web diseñada por <a
                            href="https://wa.me/34722340487"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="hover:underline">Joaquin Rivera Tirado</a
                        >
                    </p>
                </div>
            </div>

            <style>
                @keyframes shimmer {
                    0% {
                        background-position: 0% 50%;
                    }
                    100% {
                        background-position: 200% 50%;
                    }
                }
                .animate-shimmer {
                    animation: shimmer 5s linear infinite;
                }
            </style>
        </footer>

        <!-- Splash Screen -->
        <div
            id="splash-screen"
            class="fixed inset-0 z-[100] bg-black flex items-center justify-center transition-opacity duration-1000"
        >
            <div
                class="text-white text-6xl font-chomsky tracking-widest animate-pulse"
            >
                @slc.cuts
            </div>
        </div>

        <!-- Scroll Reveal & Splash Screen Script -->
        <script>
            // Splash Screen Logic
            window.addEventListener("load", () => {
                const splash = document.getElementById("splash-screen");
                if (splash) {
                    setTimeout(() => {
                        splash.style.opacity = "0";
                        setTimeout(() => {
                            splash.style.display = "none";
                        }, 1000); // Wait for transition to finish
                    }, 500); // Min display time
                }
            });

            // Scroll Reveal Logic
            const observerOptions = {
                root: null,
                rootMargin: "0px",
                threshold: 0.1,
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add("visible");
                        observer.unobserve(entry.target); // Only animate once
                    }
                });
            }, observerOptions);

            document.addEventListener("DOMContentLoaded", () => {
                const hiddenElements =
                    document.querySelectorAll(".animate-on-scroll");
                hiddenElements.forEach((el) => observer.observe(el));
            });
        </script>

        <!-- Analytics Tracking -->
        <script>
            // Track page visit
            (function () {
                const path = window.location.pathname;
                fetch("/api/analytics/track", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ path }),
                }).catch(() => {});
            })();
        </script>

        <ProductModal client:load />
        <CartDrawer client:load />
        <style is:global>
            /* Custom Scroll Reveal Utilities */
            .animate-on-scroll {
                opacity: 0;
                transform: translateY(20px);
                transition:
                    opacity 0.8s ease-out,
                    transform 0.8s ease-out;
            }
            .animate-on-scroll.visible {
                opacity: 1;
                transform: translateY(0);
            }
        </style>
    </body>
</html>
