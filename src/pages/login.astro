---
import Layout from "../layouts/Layout.astro";
---

<style>
    @keyframes shake {
        0%,
        100% {
            transform: translateX(0);
        }
        25% {
            transform: translateX(-5px);
        }
        75% {
            transform: translateX(5px);
        }
    }
    .animate-shake {
        animation: shake 0.4s ease-in-out;
    }
</style>

<Layout title="Iniciar Sesión">
    <div class="min-h-[80vh] flex items-center justify-center py-12 px-4">
        <div class="w-full max-w-md space-y-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold tracking-tight text-gray-900">
                    Iniciar Sesión
                </h2>
                <p class="mt-2 text-sm text-gray-600">
                    Bienvenido de nuevo a SLC CUTS
                </p>
            </div>

            <form class="mt-8 space-y-6" id="loginForm">
                <div class="space-y-4 rounded-md shadow-sm">
                    <div>
                        <label for="email-address" class="sr-only"
                            >Correo electrónico</label
                        >
                        <input
                            id="email-address"
                            name="email"
                            type="email"
                            required
                            class="relative block w-full rounded-lg border-0 py-3 px-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-black sm:text-sm sm:leading-6"
                            placeholder="Correo electrónico"
                        />
                    </div>
                    <div>
                        <label for="password" class="sr-only">Contraseña</label>
                        <input
                            id="password"
                            name="password"
                            type="password"
                            required
                            class="relative block w-full rounded-lg border-0 py-3 px-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-black sm:text-sm sm:leading-6"
                            placeholder="Contraseña"
                        />
                    </div>
                </div>
                <div class="flex items-center justify-between mt-2">
                    <div class="text-sm">
                        <a
                            href="/register"
                            class="font-medium text-black hover:text-gray-700 underline"
                        >
                            ¿No tienes cuenta? Regístrate
                        </a>
                    </div>
                    <div class="text-sm">
                        <a
                            href="/forgot-password"
                            class="text-xs text-gray-600 hover:text-black hover:underline"
                        >
                            ¿Has olvidado tu contraseña?
                        </a>
                    </div>
                </div>

                <div
                    id="errorMessage"
                    class="hidden bg-red-50 border border-red-100 text-red-600 px-4 py-3 rounded-xl text-xs font-bold uppercase tracking-widest text-center mt-6 animate-shake"
                >
                </div>

                <div class="pt-4">
                    <button
                        type="submit"
                        id="submitBtn"
                        class="group relative flex w-full justify-center rounded-lg bg-black px-3 py-3 text-sm font-semibold text-white hover:bg-gray-800 disabled:opacity-50 transition-colors"
                    >
                        Acceder
                    </button>
                    <div class="mt-4 text-center">
                        <a
                            href="/"
                            class="text-xs text-gray-500 hover:text-gray-900 transition-colors"
                            >Volver a la tienda</a
                        >
                    </div>
                </div>
            </form>
        </div>

        <script>
            import { supabase } from "../lib/supabase";

            const form = document.getElementById(
                "loginForm",
            ) as HTMLFormElement;
            const errorMessage = document.getElementById("errorMessage");
            const submitBtn = document.getElementById(
                "submitBtn",
            ) as HTMLButtonElement;

            // Check if already logged in
            supabase.auth.getSession().then(({ data: { session } }: any) => {
                if (session) {
                    // Stay on the login page or redirect to where they came from
                }
            });

            form?.addEventListener("submit", async (e) => {
                e.preventDefault();
                if (errorMessage) errorMessage.classList.add("hidden");
                submitBtn.disabled = true;
                submitBtn.innerText = "Verificando...";

                const formData = new FormData(form);
                const email = formData.get("email") as string;
                const password = formData.get("password") as string;

                try {
                    console.log("Intentando login...");
                    const { data, error } =
                        await supabase.auth.signInWithPassword({
                            email,
                            password,
                        });

                    if (error) {
                        console.error("Error Auth:", error.message);
                        throw error;
                    }

                    if (data.session) {
                        console.log(
                            "Sesión iniciada. Buscando perfil admin...",
                        );
                        // Check if admin in our users table
                        const { data: profile, error: profileError } =
                            await supabase
                                .from("users")
                                .select("role")
                                .eq("id", data.session.user.id)
                                .single();

                        console.log(
                            "Datos perfil:",
                            profile,
                            "Error perfil:",
                            profileError,
                        );

                        if (profileError) {
                            console.error(
                                "Error perfil:",
                                profileError.message,
                            );
                            await supabase.auth.signOut();
                            throw new Error(
                                "Error al verificar permisos: " +
                                    profileError.message,
                            );
                        }

                        console.log("Sesión iniciada correctamente.");

                        // Set cookies for SSR
                        const session = data.session;
                        if (session) {
                            const maxAge = 60 * 60 * 24 * 7; // 7 days
                            document.cookie = `sb-access-token=${session.access_token}; path=/; max-age=${maxAge}; SameSite=Lax; samesite=lax`;
                            document.cookie = `sb-refresh-token=${session.refresh_token}; path=/; max-age=${maxAge}; SameSite=Lax; samesite=lax`;
                        }

                        // Redirect based on role
                        if (profile?.role === "admin") {
                            window.location.href = "/admin";
                        } else {
                            window.location.href = "/";
                        }
                        return;
                    }
                } catch (error: any) {
                    console.error("Error completo:", error);

                    let friendlyMessage = error.message;

                    // Error mapping for Spanish
                    if (
                        error.message.includes("Invalid login credentials") ||
                        error.message.includes("Email not confirmed")
                    ) {
                        friendlyMessage =
                            "Correo electrónico o contraseña incorrectos.";
                    } else if (error.message.includes("rate limit")) {
                        friendlyMessage =
                            "Demasiados intentos. Por favor, espera un momento.";
                    } else if (error.message.includes("Database error")) {
                        friendlyMessage =
                            "Error de conexión. Inténtalo de nuevo más tarde.";
                    }

                    if (errorMessage) {
                        errorMessage.innerText = friendlyMessage;
                        errorMessage.classList.remove("hidden");
                    }
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerText = "Acceder";
                    }
                }
            });
        </script>
    </div>
</Layout>
