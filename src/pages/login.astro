---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Acceso Administrativo">
    <div class="min-h-[80vh] flex items-center justify-center py-12 px-4">
        <div class="w-full max-w-md space-y-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold tracking-tight text-gray-900">
                    Panel de Administración
                </h2>
                <p class="mt-2 text-sm text-gray-600">
                    Acceso restringido para personal autorizado
                </p>
            </div>

            <form class="mt-8 space-y-6" id="loginForm">
                <div class="space-y-4 rounded-md shadow-sm">
                    <div>
                        <label for="email-address" class="sr-only"
                            >Correo electrónico</label
                        >
                        <input
                            id="email-address"
                            name="email"
                            type="email"
                            required
                            class="relative block w-full rounded-lg border-0 py-3 px-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-black sm:text-sm sm:leading-6"
                            placeholder="Correo electrónico"
                        />
                    </div>
                    <div>
                        <label for="password" class="sr-only">Contraseña</label>
                        <input
                            id="password"
                            name="password"
                            type="password"
                            required
                            class="relative block w-full rounded-lg border-0 py-3 px-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-black sm:text-sm sm:leading-6"
                            placeholder="Contraseña"
                        />
                    </div>
                </div>

                <div
                    id="errorMessage"
                    class="hidden text-red-500 text-xs text-center font-bold uppercase tracking-widest"
                >
                </div>

                <div>
                    <button
                        type="submit"
                        id="submitBtn"
                        class="group relative flex w-full justify-center rounded-lg bg-black px-3 py-3 text-sm font-semibold text-white hover:bg-gray-800 disabled:opacity-50 transition-colors"
                    >
                        Entrar al Panel
                    </button>
                    <div class="mt-4 text-center">
                        <a
                            href="/"
                            class="text-xs text-gray-500 hover:text-gray-900 transition-colors"
                            >Volver a la tienda</a
                        >
                    </div>
                </div>
            </form>

            <script>
                import { supabase } from "../lib/supabase";

                const form = document.getElementById(
                    "loginForm",
                ) as HTMLFormElement;
                const errorMessage = document.getElementById("errorMessage");
                const submitBtn = document.getElementById(
                    "submitBtn",
                ) as HTMLButtonElement;

                // Check if already logged in and is admin
                supabase.auth
                    .getSession()
                    .then(({ data: { session } }: any) => {
                        if (session) {
                            // verify role before redirecting to avoid loop
                            supabase
                                .from("users")
                                .select("role")
                                .eq("id", session.user.id)
                                .single()
                                .then(({ data: profile }: any) => {
                                    if (
                                        profile?.role?.toLowerCase().trim() ===
                                        "admin"
                                    ) {
                                        window.location.href = "/admin";
                                    }
                                });
                        }
                    });

                form?.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    if (errorMessage) errorMessage.classList.add("hidden");
                    submitBtn.disabled = true;
                    submitBtn.innerText = "Verificando...";

                    const formData = new FormData(form);
                    const email = formData.get("email") as string;
                    const password = formData.get("password") as string;

                    try {
                        console.log("Intentando login...");
                        const { data, error } =
                            await supabase.auth.signInWithPassword({
                                email,
                                password,
                            });

                        if (error) {
                            console.error("Error Auth:", error.message);
                            throw error;
                        }

                        if (data.session) {
                            console.log(
                                "Sesión iniciada. Buscando perfil admin...",
                            );
                            // Check if admin in our users table
                            const { data: profile, error: profileError } =
                                await supabase
                                    .from("users")
                                    .select("role")
                                    .eq("id", data.session.user.id)
                                    .single();

                            console.log(
                                "Datos perfil:",
                                profile,
                                "Error perfil:",
                                profileError,
                            );

                            if (profileError) {
                                console.error(
                                    "Error perfil:",
                                    profileError.message,
                                );
                                await supabase.auth.signOut();
                                throw new Error(
                                    "Error al verificar permisos: " +
                                        profileError.message,
                                );
                            }

                            const userRole = profile?.role
                                ?.toLowerCase()
                                .trim();
                            console.log("Rol detectado:", userRole);

                            if (userRole !== "admin") {
                                console.warn(
                                    "Acceso denegado para el rol:",
                                    userRole,
                                );
                                await supabase.auth.signOut();
                                throw new Error(
                                    "Acceso denegado: No tienes permisos de administrador.",
                                );
                            }

                            console.log("¡Todo correcto! Redirigiendo...");
                            window.location.href = "/admin";
                        }
                    } catch (error: any) {
                        console.error("Error completo:", error);
                        if (errorMessage) {
                            errorMessage.innerText = error.message;
                            errorMessage.classList.remove("hidden");
                        }
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerText = "Entrar al Panel";
                    }
                });
            </script>
        </div>
    </div>
</Layout>
