---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Recuperar Contraseña">
    <div class="min-h-[80vh] flex items-center justify-center py-12 px-4">
        <div class="w-full max-w-md space-y-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold tracking-tight text-gray-900">
                    Recuperar Contraseña
                </h2>
                <p class="mt-2 text-sm text-gray-600">
                    Introduce tu correo electrónico y te enviaremos un enlace
                    para restablecer tu contraseña.
                </p>
            </div>

            <form class="mt-8 space-y-6" id="forgotPasswordForm">
                <div class="space-y-4 rounded-md shadow-sm">
                    <div>
                        <label for="email-address" class="sr-only"
                            >Correo electrónico</label
                        >
                        <input
                            id="email-address"
                            name="email"
                            type="email"
                            required
                            class="relative block w-full rounded-lg border-0 py-3 px-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-black sm:text-sm sm:leading-6"
                            placeholder="Correo electrónico"
                        />
                    </div>
                </div>

                <div
                    id="messageBox"
                    class="hidden text-center text-sm font-medium p-3 rounded-md"
                >
                </div>

                <div>
                    <button
                        type="submit"
                        id="submitBtn"
                        class="group relative flex w-full justify-center rounded-lg bg-black px-3 py-3 text-sm font-semibold text-white hover:bg-gray-800 disabled:opacity-50 transition-colors"
                    >
                        Enviar enlace de recuperación
                    </button>
                    <div class="mt-4 text-center">
                        <a
                            href="/login"
                            class="text-xs text-gray-500 hover:text-gray-900 transition-colors"
                        >
                            Volver al inicio de sesión
                        </a>
                    </div>
                </div>
            </form>

            <script>
                import { supabase } from "../lib/supabase";

                const form = document.getElementById(
                    "forgotPasswordForm",
                ) as HTMLFormElement;
                const messageBox = document.getElementById("messageBox");
                const submitBtn = document.getElementById(
                    "submitBtn",
                ) as HTMLButtonElement;

                form?.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    if (messageBox) {
                        messageBox.classList.add("hidden");
                        messageBox.className =
                            "hidden text-center text-sm font-medium p-3 rounded-md"; // Reset classes
                    }
                    submitBtn.disabled = true;
                    submitBtn.innerText = "Enviando...";

                    const formData = new FormData(form);
                    const email = formData.get("email") as string;

                    // Construct the redirect URL for the reset password page
                    const redirectTo =
                        window.location.origin + "/reset-password";

                    try {
                        const { error } =
                            await supabase.auth.resetPasswordForEmail(email, {
                                redirectTo,
                            });

                        if (error) throw error;

                        if (messageBox) {
                            messageBox.textContent =
                                "Si el correo existe, recibirás un enlace en unos momentos.";
                            messageBox.classList.remove("hidden");
                            messageBox.classList.add(
                                "bg-green-50",
                                "text-green-700",
                            );
                        }
                        form.reset();
                    } catch (error: any) {
                        console.error("Error:", error);
                        if (messageBox) {
                            messageBox.textContent =
                                error.message ||
                                "Ha ocurrido un error al intentar enviar el correo.";
                            messageBox.classList.remove("hidden");
                            messageBox.classList.add(
                                "bg-red-50",
                                "text-red-700",
                            );
                        }
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerText = "Enviar enlace de recuperación";
                    }
                });
            </script>
        </div>
    </div>
</Layout>
