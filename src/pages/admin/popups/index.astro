---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

export const prerender = false;

// Fetch popups
const { data: popups, error } = await supabase
    .from("popups")
    .select("*")
    .order("created_at", { ascending: false });

// Fetch settings
const { data: settings } = await supabase.from("settings").select("*");

const popupsEnabled =
    settings?.find((s) => s.key === "popups_enabled")?.value ?? true;

const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString("es-ES", {
        day: "2-digit",
        month: "short",
        year: "numeric",
    });
};
---

<AdminLayout title="Pop-ups" activeSection="popups">
    <div
        class="flex flex-col xl:flex-row justify-between items-start gap-8 mb-10"
    >
        <div>
            <h1 class="text-4xl font-black text-white tracking-tight mb-2">
                Gesti√≥n de <span class="text-white/40 italic">Pop-ups</span>
            </h1>
            <p class="text-gray-500 font-medium text-sm lg:text-base">
                Crea y administra avisos promocionales para tu tienda
            </p>
        </div>

        <div
            class="flex items-center gap-4 p-4 bg-gray-900/50 backdrop-blur-xl rounded-2xl border border-white/5 shadow-2xl"
        >
            <span
                class="text-[10px] font-black text-gray-500 uppercase tracking-widest pl-2"
                >Sistema Global</span
            >
            <button
                id="togglePopups"
                data-enabled={popupsEnabled}
                class={`h-10 px-6 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${
                    popupsEnabled
                        ? "bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 hover:bg-emerald-500/20"
                        : "bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20"
                }`}
            >
                {popupsEnabled ? "Activo" : "Desactivado"}
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        <!-- Create Popup Form -->
        <div class="space-y-8">
            <div
                class="p-8 bg-gray-900/50 backdrop-blur-xl rounded-[2.5rem] border border-white/5 shadow-2xl"
            >
                <div class="flex items-center gap-3 mb-8">
                    <span class="text-2xl">‚ú®</span>
                    <h2 class="text-xl font-black text-white italic uppercase">
                        Crear Nuevo Pop-up
                    </h2>
                </div>

                <form id="popupForm" class="space-y-6">
                    <div>
                        <label
                            class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3"
                            >T√≠tulo</label
                        >
                        <input
                            type="text"
                            id="popupTitle"
                            required
                            placeholder="Ej: ¬°Oferta Flash 2x1!"
                            class="w-full h-14 bg-black/40 border border-white/10 rounded-2xl px-6 text-sm font-bold text-white focus:border-white/20 focus:outline-none transition-all"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3"
                            >Contenido / Descripci√≥n</label
                        >
                        <textarea
                            id="popupContent"
                            required
                            rows="4"
                            placeholder="Describe la promoci√≥n..."
                            class="w-full bg-black/40 border border-white/10 rounded-2xl p-6 text-sm font-medium text-white focus:border-white/20 focus:outline-none transition-all resize-none"
                        ></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3"
                                >Texto Bot√≥n</label
                            >
                            <input
                                type="text"
                                id="popupButtonText"
                                placeholder="Ej: Ver Oferta"
                                class="w-full h-14 bg-black/40 border border-white/10 rounded-2xl px-6 text-sm font-bold text-white focus:border-white/20 focus:outline-none transition-all"
                            />
                        </div>
                        <div>
                            <label
                                class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3"
                                >Link Bot√≥n</label
                            >
                            <input
                                type="text"
                                id="popupButtonLink"
                                placeholder="/shop/offers"
                                class="w-full h-14 bg-black/40 border border-white/10 rounded-2xl px-6 text-sm font-bold text-white focus:border-white/20 focus:outline-none transition-all"
                            />
                        </div>
                    </div>

                    <div>
                        <div
                            class="h-[200px] bg-black/40 border border-white/10 rounded-2xl relative group overflow-hidden flex flex-col items-center justify-center border-dashed"
                        >
                            <input
                                type="file"
                                id="popupImageFile"
                                accept="image/*"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
                            />
                            <div
                                id="imagePreview"
                                class="absolute inset-0 w-full h-full hidden"
                            >
                                <img
                                    src=""
                                    class="w-full h-full object-cover opacity-50 group-hover:opacity-40 transition-opacity"
                                />
                            </div>
                            <div
                                class="z-10 text-center pointer-events-none"
                                id="uploadPlaceholder"
                            >
                                <div
                                    class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center mx-auto mb-3"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="text-white"
                                        ><rect
                                            width="18"
                                            height="18"
                                            x="3"
                                            y="3"
                                            rx="2"
                                            ry="2"></rect><circle
                                            cx="9"
                                            cy="9"
                                            r="2"></circle><path
                                            d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"
                                        ></path></svg
                                    >
                                </div>
                                <p
                                    class="text-xs font-bold text-gray-400 uppercase tracking-widest"
                                >
                                    Subir Imagen
                                </p>
                                <p class="text-[10px] text-gray-600 mt-1">
                                    Click o arrastrar
                                </p>
                            </div>
                            <input type="hidden" id="popupImage" />
                        </div>
                    </div>

                    <div class="pt-4">
                        <button
                            type="submit"
                            id="savePopupBtn"
                            class="w-full h-16 bg-white text-black rounded-2xl text-[11px] font-black uppercase tracking-widest hover:scale-[1.01] active:scale-[0.99] transition-all shadow-2xl flex items-center justify-center gap-3"
                        >
                            <span>Guardar y Publicar</span>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="18"
                                height="18"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="3"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><path d="M5 12h14"></path><path
                                    d="m12 5 7 7-7 7"></path></svg
                            >
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- History Popups -->
        <div class="space-y-8">
            <div
                class="p-8 bg-gray-900/50 backdrop-blur-xl rounded-[2.5rem] border border-white/5 shadow-2xl flex flex-col h-full"
            >
                <div class="flex items-center justify-between mb-8 shrink-0">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">üìú</span>
                        <h2
                            class="text-xl font-black text-white italic uppercase"
                        >
                            Historial
                        </h2>
                    </div>
                    <span
                        class="text-[10px] font-bold text-gray-500 uppercase tracking-widest"
                        >Se muestra el m√°s reciente activo</span
                    >
                </div>

                <div class="space-y-6 overflow-y-auto pr-2 custom-scrollbar">
                    {
                        popups?.map((pop: any) => (
                            <div
                                class={`p-6 bg-white/5 rounded-3xl border transition-all ${pop.is_active ? "border-emerald-500/30" : "border-white/5"}`}
                            >
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex flex-col gap-1">
                                        <span
                                            class={`text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded-full inline-block w-fit ${pop.is_active ? "bg-emerald-500/10 text-emerald-400" : "bg-gray-500/10 text-gray-500"}`}
                                        >
                                            {pop.is_active
                                                ? "Activo"
                                                : "Inactivo"}
                                        </span>
                                        <h3 class="text-lg font-black text-white uppercase italic">
                                            {pop.title}
                                        </h3>
                                        <span class="text-[10px] font-bold text-gray-600 uppercase tracking-widest">
                                            {formatDate(pop.created_at)}
                                        </span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button
                                            class="toggle-active-popup p-2 bg-white/5 border border-white/10 rounded-xl hover:bg-white hover:text-black transition-all"
                                            data-id={pop.id}
                                            data-active={pop.is_active}
                                            title={
                                                pop.is_active
                                                    ? "Desactivar"
                                                    : "Activar"
                                            }
                                        >
                                            {pop.is_active ? "‚è∏" : "‚ñ∂Ô∏è"}
                                        </button>
                                        <button
                                            class="edit-popup p-2 bg-white/5 border border-white/10 rounded-xl hover:bg-white hover:text-black transition-all"
                                            data-id={pop.id}
                                            data-title={pop.title}
                                            data-content={pop.content}
                                            data-btn-text={pop.button_text}
                                            data-btn-link={pop.button_link}
                                            data-image={pop.image_url}
                                            title="Editar"
                                        >
                                            ‚úèÔ∏è
                                        </button>
                                        <button
                                            class="delete-popup p-2 bg-white/5 border border-white/10 rounded-xl hover:bg-red-500/20 hover:text-red-400 transition-all"
                                            data-id={pop.id}
                                            title="Eliminar"
                                        >
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-400 font-medium leading-relaxed italic line-clamp-2">
                                    "{pop.content}"
                                </p>
                            </div>
                        ))
                    }

                    {
                        (!popups || popups.length === 0) && (
                            <div class="text-center py-20 opacity-30">
                                <span class="text-4xl block mb-4">üì≠</span>
                                <p class="text-[10px] font-black uppercase tracking-widest">
                                    No hay pop-ups creados
                                </p>
                            </div>
                        )
                    }
                </div>
            </div>
        </div>
    </div>
</AdminLayout>

<script>
    import { supabase } from "../../../lib/supabase";

    // Modals
    const deleteModal = document.getElementById("deleteConfirmModal"); // Reusing if exists or creating similar

    // Image Upload Logic
    const fileInput = document.getElementById(
        "popupImageFile",
    ) as HTMLInputElement;
    const hiddenInput = document.getElementById(
        "popupImage",
    ) as HTMLInputElement;
    const imagePreview = document.getElementById("imagePreview");
    const uploadPlaceholder = document.getElementById("uploadPlaceholder");

    fileInput?.addEventListener("change", async (e: any) => {
        const file = e.target.files[0];
        if (!file) return;

        // Show preview immediately
        const reader = new FileReader();
        reader.onload = (e) => {
            if (imagePreview && uploadPlaceholder) {
                const img = imagePreview.querySelector("img");
                if (img) img.src = e.target?.result as string;
                imagePreview.classList.remove("hidden");
                uploadPlaceholder.classList.add("hidden");
            }
        };
        reader.readAsDataURL(file);

        // Upload to Supabase
        const fileExt = file.name.split(".").pop();
        const fileName = `${Math.random()}.${fileExt}`;
        const filePath = `${fileName}`;

        const { data, error } = await supabase.storage
            .from("popup_images")
            .upload(filePath, file);

        if (error) {
            (window as any).showToast(
                "Error",
                "Error al subir imagen",
                "error",
            );
        } else {
            const { data: publicUrl } = supabase.storage
                .from("popup_images")
                .getPublicUrl(filePath);

            if (hiddenInput) hiddenInput.value = publicUrl.publicUrl;
        }
    });

    // Toggle Popups System
    const toggleBtn = document.getElementById("togglePopups");
    toggleBtn?.addEventListener("click", async () => {
        const currentStatus = toggleBtn.getAttribute("data-enabled") === "true";
        const newStatus = !currentStatus;

        const { error } = await supabase
            .from("settings")
            .upsert({ key: "popups_enabled", value: newStatus });

        if (!error) {
            location.reload();
        } else {
            (window as any).showToast(
                "Error",
                "No se pudo cambiar el estado",
                "error",
            );
        }
    });

    let isEditing = false;
    let editingId: string | null = null;
    const saveBtn = document.getElementById("savePopupBtn");
    const popupForm = document.getElementById("popupForm");

    // Create/Edit Popup
    popupForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = (
            document.getElementById("popupTitle") as HTMLInputElement
        ).value;
        const content = (
            document.getElementById("popupContent") as HTMLTextAreaElement
        ).value;
        const button_text = (
            document.getElementById("popupButtonText") as HTMLInputElement
        ).value;
        const button_link = (
            document.getElementById("popupButtonLink") as HTMLInputElement
        ).value;
        const image_url = (
            document.getElementById("popupImage") as HTMLInputElement
        ).value;

        const payload: any = {
            title,
            content,
            button_text,
            button_link,
            image_url,
            is_active: true,
        };

        let error;

        if (isEditing && editingId) {
            const result = await supabase
                .from("popups")
                .update(payload)
                .eq("id", editingId);
            error = result.error;
        } else {
            const result = await supabase.from("popups").insert([payload]);
            error = result.error;
        }

        if (!error) {
            (window as any).showToast(
                "√âxito",
                `Pop-up ${isEditing ? "actualizado" : "creado"} correctamente`,
                "success",
            );
            setTimeout(() => location.reload(), 1500);
        } else {
            (window as any).showToast(
                "Error",
                "No se pudo guardar el pop-up",
                "error",
            );
        }
    });

    // Populate Edit
    document.querySelectorAll(".edit-popup").forEach((btn) => {
        btn.addEventListener("click", () => {
            isEditing = true;
            editingId = btn.getAttribute("data-id");

            const title = btn.getAttribute("data-title");
            const content = btn.getAttribute("data-content");
            const btnText = btn.getAttribute("data-btn-text");
            const btnLink = btn.getAttribute("data-btn-link");
            const imageUrl = btn.getAttribute("data-image");

            (document.getElementById("popupTitle") as HTMLInputElement).value =
                title || "";
            (
                document.getElementById("popupContent") as HTMLTextAreaElement
            ).value = content || "";
            (
                document.getElementById("popupButtonText") as HTMLInputElement
            ).value = btnText || "";
            (
                document.getElementById("popupButtonLink") as HTMLInputElement
            ).value = btnLink || "";
            (document.getElementById("popupImage") as HTMLInputElement).value =
                imageUrl || "";

            if (imageUrl) {
                if (imagePreview && uploadPlaceholder) {
                    const img = imagePreview.querySelector("img");
                    if (img) img.src = imageUrl;
                    imagePreview.classList.remove("hidden");
                    uploadPlaceholder.classList.add("hidden");
                }
            }

            // Scroll to form
            popupForm?.scrollIntoView({ behavior: "smooth" });

            // Change button text
            if (saveBtn) {
                saveBtn.innerHTML = `
                    <span>Actualizar Pop-up</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
                 `;
            }
        });
    });

    // Toggle Active Status
    document.querySelectorAll(".toggle-active-popup").forEach((btn) => {
        btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const isActive = btn.getAttribute("data-active") === "true";

            const { error } = await supabase
                .from("popups")
                .update({ is_active: !isActive })
                .eq("id", id);

            if (!error) {
                location.reload();
            } else {
                (window as any).showToast(
                    "Error",
                    "No se pudo cambiar el estado",
                    "error",
                );
            }
        });
    });

    // Delete Popup replaced with custom modal check
    document.querySelectorAll(".delete-popup").forEach((btn) => {
        btn.addEventListener("click", async () => {
            // Create a custom modal on the fly if not exists or reuse a generic one
            // For simplicity, we'll use a confirm but styling it would require injecting HTML
            // Since the user explicitly asked to "eliminate alerts and replace with modals", we MUST inject a modal HTML
            createConfirmModal(async () => {
                const id = btn.getAttribute("data-id");
                const { error } = await supabase
                    .from("popups")
                    .delete()
                    .eq("id", id);

                if (!error) {
                    location.reload();
                } else {
                    (window as any).showToast(
                        "Error",
                        "No se pudo eliminar el pop-up",
                        "error",
                    );
                }
            });
        });
    });

    function createConfirmModal(onConfirm: () => void) {
        const modalId = "confirm-delete-modal-dynamic";
        let modal = document.getElementById(modalId);

        if (!modal) {
            modal = document.createElement("div");
            modal.id = modalId;
            modal.className =
                "fixed inset-0 bg-black/70 z-[200] flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none";
            modal.innerHTML = `
                 <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">Eliminar Pop-up</h3>
                            <p class="text-sm text-gray-400">Esta acci√≥n es irreversible</p>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button id="${modalId}-confirm" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold uppercase text-sm tracking-wider transition-all">Eliminar</button>
                        <button id="${modalId}-cancel" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold uppercase text-sm tracking-wider transition-all">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Open
        modal.classList.remove("pointer-events-none", "opacity-0");
        const content = modal.firstElementChild;
        if (content) {
            content.classList.remove("scale-95");
            content.classList.add("scale-100");
        }

        // Handlers
        const confirmBtn = document.getElementById(`${modalId}-confirm`);
        const cancelBtn = document.getElementById(`${modalId}-cancel`);

        const close = () => {
            modal!.classList.add("opacity-0");
            if (content) {
                content.classList.remove("scale-100");
                content.classList.add("scale-95");
            }
            setTimeout(() => modal!.classList.add("pointer-events-none"), 300);
        };

        confirmBtn!.onclick = () => {
            onConfirm();
            close();
        };

        cancelBtn!.onclick = close;
    }
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
</style>
