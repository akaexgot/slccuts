---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase, getSupabasePageClient } from "../../../lib/supabase";

// Get authenticated client for this request
const supabaseClient = await getSupabasePageClient(Astro.cookies);

// Fetch popups with SSR auth session
const { data: popups, error: popupsError } = await supabaseClient
    .from("popups")
    .select("*")
    .order("created_at", { ascending: false });

if (popupsError) {
    console.error("Error fetching popups (SSR):", popupsError);
}

// Settings fetching removed as per request
// const { data: settings } = await supabase.from("settings").select("*");
// const popupsEnabled = parseBoolSetting("popups_enabled", true);

const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString("es-ES", {
        day: "2-digit",
        month: "short",
        year: "numeric",
    });
};
---

<AdminLayout
    title="GestiÃ³n de"
    highlightTitle="Pop-ups"
    subtitle="Configura avisos y promociones emergentes para tus visitantes"
    activeSection="popups"
>
    <div class="flex flex-col xl:flex-row justify-end items-center gap-8 mb-10">
        <div class="flex flex-wrap items-center gap-4">
            <button
                id="openPopupModal"
                class="h-16 px-8 bg-white text-black rounded-3xl text-[11px] font-black uppercase tracking-widest hover:scale-[1.05] active:scale-[0.95] transition-all shadow-2xl flex items-center gap-3"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="3"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><line x1="12" y1="5" x2="12" y2="19"></line><line
                        x1="5"
                        y1="12"
                        x2="19"
                        y2="12"></line></svg
                >
                <span>Crear Pop-up</span>
            </button>
        </div>
    </div>

    <!-- Unified List of Popups -->
    <div
        class="p-10 bg-gray-900/50 backdrop-blur-xl rounded-[3rem] border border-white/5 shadow-2xl"
    >
        <div class="flex items-center justify-between mb-10">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center text-2xl"
                >
                    ðŸ“œ
                </div>
                <div>
                    <h2 class="text-2xl font-black text-white italic uppercase">
                        Todos los Pop-ups
                    </h2>
                    <p
                        class="text-[10px] font-bold text-gray-600 uppercase tracking-widest mt-1"
                    >
                        Lista completa de promociones creadas
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse"
                ></span>
                <span
                    class="text-[10px] font-black text-emerald-500 uppercase tracking-widest"
                >
                    Un solo item activo a la vez
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-3 gap-6">
            {
                popups?.map((pop: any) => (
                    <div
                        class={`group relative p-8 rounded-[2.5rem] border transition-all duration-500 ${pop.is_active ? "bg-emerald-500/5 border-emerald-500/30 ring-1 ring-emerald-500/20" : "bg-white/5 border-white/5 hover:border-white/10"}`}
                    >
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex flex-col gap-3">
                                <div class="flex items-center gap-2">
                                    <span
                                        class={`text-[9px] font-black uppercase tracking-widest px-4 py-1.5 rounded-full inline-block w-fit transition-all ${pop.is_active ? "bg-emerald-500 text-black shadow-[0_0_20px_rgba(16,185,129,0.4)]" : "bg-black/40 text-gray-500 border border-white/5"}`}
                                    >
                                        {pop.is_active
                                            ? "ðŸ”¥ ACTIVO"
                                            : "ARCHIVADO"}
                                    </span>
                                    {pop.image_url && (
                                        <span class="text-[9px] font-black uppercase tracking-widest px-4 py-1.5 bg-blue-500/10 text-blue-400 border border-blue-500/20 rounded-full">
                                            Imagen
                                        </span>
                                    )}
                                </div>
                                <h3 class="text-2xl font-black text-white uppercase italic tracking-tighter leading-none group-hover:text-emerald-400 transition-colors">
                                    {pop.title}
                                </h3>
                                <span class="text-[10px] font-bold text-gray-600 uppercase tracking-widest">
                                    {formatDate(pop.created_at)}
                                </span>
                            </div>

                            <div class="flex flex-col gap-2 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity translate-x-4 group-hover:translate-x-0">
                                <button
                                    class="toggle-active-popup p-4 bg-white/5 border border-white/10 rounded-2xl hover:bg-white hover:text-black transition-all shadow-xl"
                                    data-id={pop.id}
                                    data-active={pop.is_active}
                                    title={
                                        pop.is_active
                                            ? "Desactivar"
                                            : "Activar (DesactivarÃ¡ el actual)"
                                    }
                                >
                                    {pop.is_active ? (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="3"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <rect
                                                x="6"
                                                y="4"
                                                width="4"
                                                height="16"
                                            />
                                            <rect
                                                x="14"
                                                y="4"
                                                width="4"
                                                height="16"
                                            />
                                        </svg>
                                    ) : (
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="3"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <polygon points="5 3 19 12 5 21 5 3" />
                                        </svg>
                                    )}
                                </button>
                                <button
                                    class="edit-popup p-4 bg-white/5 border border-white/10 rounded-2xl hover:bg-white hover:text-black transition-all shadow-xl"
                                    data-id={pop.id}
                                    data-title={pop.title}
                                    data-content={pop.content}
                                    data-btn-text={pop.button_text}
                                    data-btn-link={pop.button_link}
                                    data-image={pop.image_url}
                                    title="Editar"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <>
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                                        </>
                                    </svg>
                                </button>
                                <button
                                    class="delete-popup p-4 bg-red-500/10 border border-red-500/20 rounded-2xl hover:bg-red-500 text-white transition-all shadow-xl"
                                    data-id={pop.id}
                                    title="Eliminar"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <>
                                            <path d="M3 6h18" />
                                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                                            <line
                                                x1="10"
                                                y1="11"
                                                x2="10"
                                                y2="17"
                                            />
                                            <line
                                                x1="14"
                                                y1="11"
                                                x2="14"
                                                y2="17"
                                            />
                                        </>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="relative">
                            <p class="text-sm text-gray-400 font-medium leading-relaxed italic line-clamp-3 mb-6 pr-12">
                                "{pop.content}"
                            </p>

                            {pop.button_text && (
                                <div class="flex items-center gap-2 text-[9px] font-black text-emerald-400 tracking-widest uppercase bg-emerald-400/10 px-3 py-1.5 rounded-lg w-fit">
                                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-400" />
                                    {pop.button_text}
                                </div>
                            )}
                        </div>
                    </div>
                ))
            }

            {
                (!popups || popups.length === 0) && (
                    <div class="col-span-full text-center py-32 opacity-20">
                        <span class="text-7xl block mb-6">ðŸ“­</span>
                        <p class="text-sm font-black uppercase tracking-[0.3em]">
                            Bandeja vacÃ­a
                        </p>
                    </div>
                )
            }
        </div>
    </div>

    <!-- Create/Edit Popup Modal -->
    <div
        id="popupModal"
        class="fixed inset-0 z-[150] flex items-center justify-center opacity-0 pointer-events-none transition-all duration-500"
    >
        <div
            id="modalOverlay"
            class="absolute inset-0 bg-black/95 backdrop-blur-xl"
        >
        </div>
        <div
            class="relative w-full max-w-2xl bg-[#0a0a0a] rounded-[3.5rem] border border-white/10 shadow-[0_50px_100px_rgba(0,0,0,0.8)] overflow-hidden transform scale-95 transition-transform duration-500"
            id="modalContent"
        >
            <div class="p-12">
                <div class="flex items-center justify-between mb-10">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl" id="modalIcon">âœ¨</span>
                        <h2
                            class="text-3xl font-black text-white italic uppercase tracking-tighter"
                            id="modalTitle"
                        >
                            Nuevo Pop-up
                        </h2>
                    </div>
                    <button
                        id="closePopupModal"
                        class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center text-white hover:bg-white hover:text-black transition-all"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="3"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><line x1="18" y1="6" x2="6" y2="18"></line><line
                                x1="6"
                                y1="6"
                                x2="18"
                                y2="18"></line></svg
                        >
                    </button>
                </div>

                <form id="popupForm" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label
                                    class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 ml-2"
                                    >TÃ­tulo Promocional</label
                                >
                                <input
                                    type="text"
                                    id="popupTitle"
                                    required
                                    placeholder="Ej: Â¡SALE 50%!"
                                    class="w-full h-16 bg-white/5 border border-white/10 rounded-[1.5rem] px-6 text-sm font-bold text-white focus:border-white/30 focus:bg-white/10 focus:outline-none transition-all"
                                />
                            </div>

                            <div>
                                <label
                                    class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 ml-2"
                                    >Contenido / DescripciÃ³n</label
                                >
                                <textarea
                                    id="popupContent"
                                    required
                                    rows="4"
                                    placeholder="CuÃ©ntales mÃ¡s sobre la oferta..."
                                    class="w-full bg-white/5 border border-white/10 rounded-[1.5rem] p-6 text-sm font-medium text-white focus:border-white/30 focus:bg-white/10 focus:outline-none transition-all resize-none"
                                ></textarea>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div
                                class="h-full min-h-[200px] bg-white/5 border border-white/10 rounded-[2rem] relative group overflow-hidden flex flex-col items-center justify-center border-dashed border-2 hover:border-white/30 transition-all"
                                id="imageUploadContainer"
                            >
                                <input
                                    type="file"
                                    id="popupImageFile"
                                    accept="image/*"
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-30"
                                />
                                <div
                                    id="imagePreview"
                                    class="absolute inset-0 w-full h-full hidden z-10"
                                >
                                    <img
                                        src=""
                                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                    />
                                    <div
                                        class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                    >
                                        <p
                                            class="text-[9px] font-black text-white uppercase tracking-widest px-4 py-2 bg-black/50 rounded-full backdrop-blur-md"
                                        >
                                            Cambiar Imagen
                                        </p>
                                    </div>
                                </div>
                                <div
                                    class="z-20 text-center pointer-events-none"
                                    id="uploadPlaceholder"
                                >
                                    <div
                                        class="w-16 h-16 rounded-3xl bg-white/5 flex items-center justify-center mx-auto mb-4 border border-white/5 shadow-2xl transition-transform group-hover:scale-110"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="28"
                                            height="28"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            class="text-white"
                                            ><rect
                                                width="18"
                                                height="18"
                                                x="3"
                                                y="3"
                                                rx="2"
                                                ry="2"></rect><circle
                                                cx="9"
                                                cy="9"
                                                r="2"></circle><path
                                                d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"
                                            ></path></svg
                                        >
                                    </div>
                                    <p
                                        class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]"
                                    >
                                        Imagen Visual
                                    </p>
                                </div>
                                <input type="hidden" id="popupImage" />
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label
                                class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 ml-2"
                                >Texto del AcciÃ³n</label
                            >
                            <input
                                type="text"
                                id="popupButtonText"
                                placeholder="Ej: Â¡Ver Oferta!"
                                class="w-full h-16 bg-white/5 border border-white/10 rounded-[1.5rem] px-6 text-sm font-bold text-white focus:border-white/30 focus:bg-white/10 focus:outline-none transition-all"
                            />
                        </div>
                        <div>
                            <label
                                class="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 ml-2"
                                >Link (URL)</label
                            >
                            <select
                                id="popupButtonLink"
                                class="w-full h-16 bg-white/5 border border-white/10 rounded-[1.5rem] px-6 text-sm font-bold text-white focus:border-white/30 focus:bg-white/10 focus:outline-none transition-all appearance-none"
                            >
                                <option
                                    value=""
                                    class="bg-[#0a0a0a] text-gray-500"
                                    >Sin enlace</option
                                >
                                <option value="/" class="bg-[#0a0a0a]"
                                    >Inicio</option
                                >
                                <option value="/shop" class="bg-[#0a0a0a]"
                                    >Tienda</option
                                >
                                <option value="/services" class="bg-[#0a0a0a]"
                                    >Servicios</option
                                >
                                <option value="/contact" class="bg-[#0a0a0a]"
                                    >Contacto</option
                                >
                                <option value="/faq" class="bg-[#0a0a0a]"
                                    >Preguntas Frecuentes</option
                                >
                                <option value="/gallery" class="bg-[#0a0a0a]"
                                    >GalerÃ­a</option
                                >
                                <option value="/news" class="bg-[#0a0a0a]"
                                    >Noticias</option
                                >
                                <option value="/privacy" class="bg-[#0a0a0a]"
                                    >Privacidad</option
                                >
                                <option value="/terms" class="bg-[#0a0a0a]"
                                    >TÃ©rminos y Condiciones</option
                                >
                                <option
                                    value="/devoluciones"
                                    class="bg-[#0a0a0a]"
                                    >PolÃ­tica de Devoluciones</option
                                >
                            </select>
                        </div>
                    </div>

                    <div class="pt-6 flex gap-4">
                        <button
                            type="submit"
                            id="savePopupBtn"
                            class="flex-1 h-20 bg-white text-black rounded-3xl text-xs font-black uppercase tracking-[0.2em] hover:bg-emerald-400 transition-all shadow-[0_20px_40px_rgba(0,0,0,0.3)] flex items-center justify-center gap-4"
                        >
                            <span>Guardar Pop-up</span>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="4"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><path d="M5 12h14"></path><path
                                    d="m12 5 7 7-7 7"></path></svg
                            >
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {
        (!popups || popups.length === 0) && (
            <div class="text-center py-20 opacity-30">
                <span class="text-4xl block mb-4">ðŸ“­</span>
                <p class="text-[10px] font-black uppercase tracking-widest">
                    No hay pop-ups creados
                </p>
            </div>
        )
    }


<script>
    import { supabase } from "../../../lib/supabase";

    // Modal Elements
    const popupModal = document.getElementById("popupModal");
    const modalContent = document.getElementById("modalContent");
    const openModalBtn = document.getElementById("openPopupModal");
    const closeModalBtn = document.getElementById("closePopupModal");
    const modalOverlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalIcon = document.getElementById("modalIcon");

    // Elements
    const fileInput = document.getElementById(
        "popupImageFile",
    ) as HTMLInputElement;
    const hiddenInput = document.getElementById(
        "popupImage",
    ) as HTMLInputElement;
    const imagePreview = document.getElementById("imagePreview");
    const uploadPlaceholder = document.getElementById("uploadPlaceholder");
    const saveBtn = document.getElementById("savePopupBtn");
    const popupForm = document.getElementById("popupForm");

    let isEditing = false;
    let editingId: string | null = null;
    let isUploading = false;

    const openModal = (edit = false) => {
        if (!popupModal || !modalContent) return;

        isEditing = edit;
        if (!edit) {
            editingId = null;
            if (popupForm) (popupForm as HTMLFormElement).reset();
            if (imagePreview) {
                imagePreview.classList.add("hidden");
                imagePreview.style.zIndex = "10";
            }
            if (uploadPlaceholder) {
                uploadPlaceholder.classList.remove("hidden");
                uploadPlaceholder.style.zIndex = "20";
            }
            if (modalTitle) modalTitle.innerText = "Nuevo Pop-up";
            if (modalIcon) modalIcon.innerText = "âœ¨";
            if (hiddenInput) hiddenInput.value = "";
            if (saveBtn) {
                const span = saveBtn.querySelector("span");
                if (span) span.innerText = "Guardar Pop-up";
            }
        } else {
            if (modalTitle) modalTitle.innerText = "Editar Pop-up";
            if (modalIcon) modalIcon.innerText = "âœï¸";
            if (saveBtn) {
                const span = saveBtn.querySelector("span");
                if (span) span.innerText = "Actualizar Pop-up";
            }
        }

        popupModal.classList.remove("opacity-0", "pointer-events-none");
        modalContent.classList.remove("scale-95");
        modalContent.classList.add("scale-100");
        document.body.style.overflow = "hidden";
    };

    const closeModal = () => {
        if (!popupModal || !modalContent) return;
        popupModal.classList.add("opacity-0", "pointer-events-none");
        modalContent.classList.remove("scale-100");
        modalContent.classList.add("scale-95");
        document.body.style.overflow = "";
    };

    openModalBtn?.addEventListener("click", () => openModal(false));
    closeModalBtn?.addEventListener("click", closeModal);
    modalOverlay?.addEventListener("click", closeModal);

    // Image Upload Logic
    fileInput?.addEventListener("change", async (e: any) => {
        const file = e.target.files[0];
        if (!file) {
            console.log("No file selected");
            return;
        }

        isUploading = true;
        if (saveBtn) (saveBtn as HTMLButtonElement).disabled = true;

        console.log("File selected:", file.name);

        // Show local preview immediately using FileReader
        const reader = new FileReader();
        reader.onload = (event) => {
            const result = event.target?.result as string;
            if (imagePreview && uploadPlaceholder) {
                const img = imagePreview.querySelector("img");
                if (img) {
                    img.src = result;
                    console.log("Preview img src updated");
                }

                // Switch visibility
                imagePreview.classList.remove("hidden");
                imagePreview.style.zIndex = "40"; // Force it on top of placeholder
                uploadPlaceholder.classList.add("hidden");
                console.log("Preview UI updated locally");
            }
        };
        reader.readAsDataURL(file);

        // Upload to Cloudinary
        try {
            const formData = new FormData();
            formData.append("file", file);

            // Show loading state in placeholder (even if hidden, for next usage)
            if (uploadPlaceholder) {
                uploadPlaceholder.innerHTML = `
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                    <p class="text-[10px] font-black uppercase tracking-widest text-white">Subiendo...</p>
                `;
            }

            const res = await fetch("/api/popups/upload", {
                method: "POST",
                body: formData,
            });
            const data = await res.json();

            if (data.success && data.url) {
                if (hiddenInput) {
                    hiddenInput.value = data.url;
                    console.log(
                        "Success: Hidden input updated with:",
                        data.url,
                    );
                }
                (window as any).showToast(
                    "Ã‰xito",
                    "Imagen subida correctamente",
                    "success",
                );
            } else {
                throw new Error(data.error || "Error al subir imagen");
            }
        } catch (err: any) {
            console.error("Upload error:", err);
            (window as any).showToast(
                "Error",
                err.message || "Error al subir imagen",
                "error",
            );

            // Revert state if upload failed?
            // Better keep the local preview so user knows what they picked,
            // but hiddenInput remains empty.
        } finally {
            isUploading = false;
            if (saveBtn) (saveBtn as HTMLButtonElement).disabled = false;

            // Restore placeholder icon for future use if needed
            if (uploadPlaceholder) {
                uploadPlaceholder.innerHTML = `
                    <div class="w-16 h-16 rounded-3xl bg-white/5 flex items-center justify-center mx-auto mb-4 border border-white/5 shadow-2xl transition-transform group-hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>
                    </div>
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Imagen Visual</p>
                `;
            }
        }
    });

    // Create/Edit Popup
    popupForm?.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (isUploading) {
            (window as any).showToast(
                "Espera",
                "Espera a que termine de subir la imagen",
                "info",
            );
            return;
        }

        const title = (
            document.getElementById("popupTitle") as HTMLInputElement
        ).value;
        const content = (
            document.getElementById("popupContent") as HTMLTextAreaElement
        ).value;
        const button_text = (
            document.getElementById("popupButtonText") as HTMLInputElement
        ).value;
        const button_link = (
            document.getElementById("popupButtonLink") as HTMLSelectElement
        ).value;
        const image_url = hiddenInput ? hiddenInput.value : "";

        console.log("Submitting popup data:", { title, image_url });

        const payload: any = {
            title,
            content,
            button_text,
            button_link,
            image_url,
        };

        let error;


        if (isEditing && editingId) {
            const { error: updateError } = await supabase
                .from("popups")
                .update(payload)
                .eq("id", editingId);
            error = updateError;
        } else {
            // New popup defaults to active
            payload.is_active = true;

            // Ensure exclusivity: Deactivate all others first
            await supabase.from("popups").update({ is_active: false });

            const { error: insertError } = await supabase
                .from("popups")
                .insert([payload]);
            error = insertError;
        }

        if (!error) {
            (window as any).showToast(
                "Ã‰xito",
                `Pop-up ${isEditing ? "actualizado" : "creado"} correctamente`,
                "success",
            );
            // Small delay to let the toast be seen before reload
            setTimeout(() => {
                window.location.href =
                    window.location.pathname + "?success=true";
            }, 1000);
        } else {
            console.error("Database error:", error);
            (window as any).showToast(
                "Error",
                "Error al guardar: " + (error.message || "revisa los permisos"),
                "error",
            );
        }
    });

    // Populate Edit
    document.querySelectorAll(".edit-popup").forEach((btn) => {
        btn.addEventListener("click", () => {
            editingId = btn.getAttribute("data-id");

            const title = btn.getAttribute("data-title");
            const content = btn.getAttribute("data-content");
            const btnText = btn.getAttribute("data-btn-text");
            const btnLink = btn.getAttribute("data-btn-link");
            const imageUrl = btn.getAttribute("data-image");

            (document.getElementById("popupTitle") as HTMLInputElement).value =
                title || "";
            (
                document.getElementById("popupContent") as HTMLTextAreaElement
            ).value = content || "";
            (
                document.getElementById("popupButtonText") as HTMLInputElement
            ).value = btnText || "";
            (
                document.getElementById("popupButtonLink") as HTMLSelectElement
            ).value = btnLink || "";
            (document.getElementById("popupImage") as HTMLInputElement).value =
                imageUrl || "";

            if (imageUrl) {
                if (imagePreview && uploadPlaceholder) {
                    const img = imagePreview.querySelector("img");
                    if (img) img.src = imageUrl;
                    imagePreview.classList.remove("hidden");
                    uploadPlaceholder.classList.add("hidden");
                }
            } else {
                if (imagePreview && uploadPlaceholder) {
                    imagePreview.classList.add("hidden");
                    uploadPlaceholder.classList.remove("hidden");
                }
            }

            openModal(true);
        });
    });

    // Toggle Active Status (Exclusive)
    document.querySelectorAll(".toggle-active-popup").forEach((btn) => {
        btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const isActive = btn.getAttribute("data-active") === "true";

            // If we are activating this one, we MUST deactivate ALL others
            if (!isActive) {
                // Deactivate all others first
                const { error: deactivateError } = await supabase
                    .from("popups")
                    .update({ is_active: false })
                    .neq("id", id);

                if (deactivateError) {
                    console.error(
                        "Error deactivating other popups:",
                        deactivateError,
                    );
                    (window as any).showToast(
                        "Error",
                        "No se pudieron desactivar los otros pop-ups",
                        "error",
                    );
                    return;
                }
            }

            // Now set the target popup status
            const { error } = await supabase
                .from("popups")
                .update({ is_active: !isActive })
                .eq("id", id);

            if (!error) {
                (window as any).showToast(
                    "Ã‰xito",
                    `Pop-up ${!isActive ? "activado" : "desactivado"} correctamente`,
                    "success",
                );
                setTimeout(() => location.reload(), 1000);
            } else {
                (window as any).showToast(
                    "Error",
                    "No se pudo cambiar el estado",
                    "error",
                );
            }
        });
    });

    // Delete Popup
    document.querySelectorAll(".delete-popup").forEach((btn) => {
        btn.addEventListener("click", async () => {
            createConfirmModal(async () => {
                const id = btn.getAttribute("data-id");
                const { error } = await supabase
                    .from("popups")
                    .delete()
                    .eq("id", id);

                if (!error) {
                    location.reload();
                } else {
                    (window as any).showToast(
                        "Error",
                        "No se pudo eliminar el pop-up",
                        "error",
                    );
                }
            });
        });
    });

    function createConfirmModal(onConfirm: () => void) {
        const modalId = "confirm-delete-modal-dynamic";
        let modal = document.getElementById(modalId);

        if (!modal) {
            modal = document.createElement("div");
            modal.id = modalId;
            modal.className =
                "fixed inset-0 bg-black/90 z-[300] flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none backdrop-blur-md";
            modal.innerHTML = `
                 <div class="bg-gray-900 border border-white/10 rounded-[2.5rem] p-12 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300 shadow-[0_50px_100px_rgba(0,0,0,1)]">
                    <div class="flex flex-col items-center text-center gap-6 mb-10">
                        <div class="w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center border border-red-500/20">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </div>
                        <div>
                            <h3 class="text-2xl font-black text-white italic uppercase tracking-tighter">Â¿Eliminar Pop-up?</h3>
                            <p class="text-gray-500 text-sm font-medium mt-2">Esta acciÃ³n no se puede deshacer y el pop-up se perderÃ¡ para siempre.</p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-3">
                        <button id="${modalId}-confirm" class="w-full h-16 bg-red-500 hover:bg-red-600 text-white rounded-2xl font-black uppercase text-[11px] tracking-widest transition-all shadow-xl">SÃ­, Eliminar Permanentemente</button>
                        <button id="${modalId}-cancel" class="w-full h-16 bg-white/5 hover:bg-white hover:text-black rounded-2xl font-black uppercase text-[11px] tracking-widest transition-all border border-white/5">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        modal.classList.remove("pointer-events-none", "opacity-0");
        const content = modal.firstElementChild;
        if (content) {
            content.classList.remove("scale-95");
            content.classList.add("scale-100");
        }

        const confirmBtn = document.getElementById(`${modalId}-confirm`);
        const cancelBtn = document.getElementById(`${modalId}-cancel`);

        const close = () => {
            modal!.classList.add("opacity-0");
            if (content) {
                content.classList.remove("scale-100");
                content.classList.add("scale-95");
            }
            setTimeout(() => modal!.classList.add("pointer-events-none"), 300);
        };

        if (confirmBtn)
            confirmBtn.onclick = () => {
                onConfirm();
                close();
            };

        if (cancelBtn) cancelBtn.onclick = close;
    }
</script>

<style is:global>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
        background-clip: content-box;
    }

    @keyframes pulse-soft {
        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.05);
            opacity: 0.8;
        }
    }
    .animate-pulse-soft {
        animation: pulse-soft 2s infinite ease-in-out;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
        background-clip: content-box;
    }

    @keyframes pulse-soft {
        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.05);
            opacity: 0.8;
        }
    }
    .animate-pulse-soft {
        animation: pulse-soft 2s infinite ease-in-out;
    }
</AdminLayout>
