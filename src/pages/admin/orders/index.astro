---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";
import EmailModal from "../../../components/admin/EmailModal";
import StatusSelect from "../../../components/admin/StatusSelect";
import ShippingModal from "../../../components/admin/ShippingModal";

export const prerender = false;

// Get current filter from URL
const currentStatus = Astro.url.searchParams.get("status") || "all";
const startDate = Astro.url.searchParams.get("start_date") || "";
const endDate = Astro.url.searchParams.get("end_date") || "";
const searchId = Astro.url.searchParams.get("search_id") || "";

const statusFlow = ["pending", "paid", "shipped", "completed"];

const statusColors = {
    pending: "#3b82f6", // Blue
    paid: "#22c55e", // Green
    shipped: "#8b5cf6", // Purple
    completed: "#f59e0b", // Amber
    cancelled: "#ef4444", // Red
};

// Fetch orders with items and filter by status if not "all"
let query = supabase.from("orders").select(
    `
        *,
        order_items (
            quantity,
            price,
            product:products (name)
        )
    `,
);

if (currentStatus !== "all") {
    query = query.eq("status", currentStatus);
}

if (searchId) {
    // Clean searchId (remove # and spaces)
    const cleanId = searchId.replace("#", "").trim();

    if (cleanId.length > 20) {
        query = query.eq("id", cleanId);
    } else if (cleanId.length > 0) {
        // Match the START of the ID (since we show order.id.slice(0, 8))
        query = query.ilike("id", `${cleanId}%`);
    }
}

if (startDate) {
    query = query.gte("created_at", `${startDate}T00:00:00Z`);
}

if (endDate) {
    query = query.lte("created_at", `${endDate}T23:59:59Z`);
}

const { data: orders } = await query.order("created_at", { ascending: false });

const formatPrice = (price: number) => {
    return new Intl.NumberFormat("es-ES", {
        style: "currency",
        currency: "EUR",
    }).format(price / 100);
};

const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString("es-ES", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
    });
};
---

<AdminLayout
    title="Gesti√≥n de"
    highlightTitle="Pedidos"
    subtitle="Supervisa y filtra las compras realizadas en la tienda"
    activeSection="orders"
>
    <div class="mb-10 flex flex-col items-start gap-8">
        <div class="space-y-4 w-full">
            <!-- Filters Bar -->
            <form
                method="get"
                class="flex flex-wrap items-end gap-4 p-8 bg-white/[0.04] backdrop-blur-2xl rounded-[2.5rem] border border-white/10 shadow-2xl"
            >
                <input type="hidden" name="status" value={currentStatus} />

                <!-- Search by ID -->
                <div class="flex-1 min-w-[200px] group">
                    <label
                        class="block text-[9px] font-black text-gray-600 uppercase tracking-widest mb-2 group-focus-within:text-white transition-colors"
                    >
                        Buscar por ID
                    </label>
                    <div class="relative">
                        <span
                            class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"
                            >üîç</span
                        >
                        <input
                            type="text"
                            name="search_id"
                            value={searchId}
                            placeholder="ID del pedido..."
                            class="w-full h-11 bg-black/40 border border-white/10 rounded-xl pl-10 pr-4 text-xs font-bold text-white focus:border-white/20 focus:outline-none transition-all placeholder:text-gray-700"
                        />
                    </div>
                </div>

                <!-- Date Range -->
                <div class="flex flex-wrap gap-4">
                    <div>
                        <label
                            class="block text-[9px] font-black text-gray-600 uppercase tracking-widest mb-2"
                        >
                            Desde
                        </label>
                        <input
                            type="date"
                            name="start_date"
                            value={startDate}
                            class="h-11 bg-black/40 border border-white/10 rounded-xl px-4 text-xs font-bold text-white focus:border-white/20 focus:outline-none transition-all [color-scheme:dark]"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-[9px] font-black text-gray-600 uppercase tracking-widest mb-2"
                        >
                            Hasta
                        </label>
                        <input
                            type="date"
                            name="end_date"
                            value={endDate}
                            class="h-11 bg-black/40 border border-white/10 rounded-xl px-4 text-xs font-bold text-white focus:border-white/20 focus:outline-none transition-all [color-scheme:dark]"
                        />
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2">
                    <button
                        type="submit"
                        class="h-11 px-6 bg-white text-black rounded-xl text-[10px] font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all shadow-lg hover:shadow-white/10"
                    >
                        Filtrar
                    </button>
                    {
                        (searchId || startDate || endDate) && (
                            <a
                                href={`/admin/orders?status=${currentStatus}`}
                                class="h-11 px-6 bg-white/5 border border-white/10 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-white/10 flex items-center transition-all"
                            >
                                Limpiar
                            </a>
                        )
                    }
                </div>
            </form>
        </div>

        <!-- Status Filter Tabs -->
        <div
            class="inline-flex p-1.5 bg-white/[0.04] backdrop-blur-2xl rounded-2xl border border-white/10 shadow-2xl overflow-x-auto scrollbar-hide shrink-0"
        >
            {
                [
                    "all",
                    "pending",
                    "paid",
                    "shipped",
                    "completed",
                    "cancelled",
                ].map((status) => (
                    <a
                        href={`/admin/orders?status=${status}`}
                        class={`whitespace-nowrap px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-[0.15em] transition-all duration-300 ${
                            currentStatus === status
                                ? "bg-white text-black shadow-[0_0_20px_rgba(255,255,255,0.2)] scale-105 z-10"
                                : "text-gray-500 hover:text-white"
                        }`}
                    >
                        {status === "all"
                            ? "Todos"
                            : status === "pending"
                              ? "Pendientes"
                              : status === "paid"
                                ? "Pagados"
                                : status === "shipped"
                                  ? "Enviados"
                                  : status === "completed"
                                    ? "Listos"
                                    : "Cancelados"}
                    </a>
                ))
            }
        </div>
    </div>

    <ShippingModal client:only="react" />

    <!-- Orders Table -->
    <div class="space-y-6">
        {
            orders?.map((order: any) => {
                const contact = order.contact_info || {};
                let address = order.shipping_address || {};

                if (typeof address === "string") {
                    try {
                        address = JSON.parse(address);
                    } catch (e) {
                        address = {};
                    }
                }

                const isPickup = order.shipping_method === "pickup";
                const currentStatusIndex = statusFlow.indexOf(order.status);
                const isCancelled = order.status === "cancelled";

                return (
                    <div class="order-card group relative bg-[#0f1117] hover:bg-[#141721] rounded-[2rem] border border-white/[0.03] hover:border-white/[0.08] transition-all duration-500 overflow-hidden">
                        {/* Background Glow Effect */}
                        <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/5 blur-[80px] rounded-full group-hover:bg-white/10 transition-all duration-700 pointer-events-none" />

                        <div class="relative p-8 lg:p-10 flex flex-col 2xl:flex-row items-start 2xl:items-center gap-10">
                            {/* 1. ID / Date Section */}
                            <div class="w-full 2xl:w-40 flex-shrink-0">
                                <span class="inline-flex items-center px-3 py-1 bg-white/5 border border-white/10 rounded-full text-[10px] font-bold text-white/50 mb-3 tracking-widest">
                                    #{order.id.slice(0, 8).toUpperCase()}
                                </span>
                                <div class="space-y-1">
                                    <p class="text-white font-black text-lg leading-none italic uppercase">
                                        {
                                            formatDate(order.created_at).split(
                                                ",",
                                            )[0]
                                        }
                                    </p>
                                    <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest">
                                        {
                                            formatDate(order.created_at).split(
                                                ",",
                                            )[1]
                                        }
                                    </p>
                                </div>
                            </div>

                            {/* 2. Client Info */}
                            <div class="w-full 2xl:w-64 flex-shrink-0">
                                <h3 class="text-white font-black text-xl mb-4 tracking-tight group-hover:text-white transition-colors">
                                    {contact.name || "Invitado Especial"}
                                </h3>
                                <div class="flex flex-col gap-2">
                                    <a
                                        href={`tel:${contact.phone}`}
                                        class="flex items-center gap-3 text-gray-500 hover:text-white transition-colors group/link p-0.5"
                                    >
                                        <div class="w-7 h-7 flex items-center justify-center rounded-lg bg-gray-900 border border-white/5 text-xs">
                                            üì±
                                        </div>
                                        <span class="text-[11px] font-bold tracking-widest uppercase">
                                            {contact.phone || "Sin tel√©fono"}
                                        </span>
                                    </a>
                                    <div class="flex items-center gap-3 text-gray-500 p-0.5">
                                        <div class="w-7 h-7 flex items-center justify-center rounded-lg bg-gray-900 border border-white/5 text-xs">
                                            ‚úâÔ∏è
                                        </div>
                                        <span class="text-[10px] font-bold tracking-tight truncate max-w-[180px]">
                                            {contact.email || order.guest_email}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* 3. Delivery / Payment Method */}
                            <div class="w-full 2xl:w-48 flex-shrink-0 grid grid-cols-2 2xl:grid-cols-1 gap-4">
                                <div class="bg-gray-900/50 p-4 rounded-2xl border border-white/5">
                                    <span class="text-[9px] font-black text-gray-600 uppercase tracking-widest block mb-2">
                                        Entrega
                                    </span>
                                    <p class="text-white text-xs font-black italic flex items-center gap-2">
                                        {isPickup ? "üè™ TIENDA" : "üöö ENV√çO"}
                                    </p>
                                </div>
                                <div class="bg-gray-900/50 p-4 rounded-2xl border border-white/5">
                                    <span class="text-[9px] font-black text-gray-600 uppercase tracking-widest block mb-2">
                                        Pago
                                    </span>
                                    <p class="text-white text-xs font-black italic flex items-center gap-2">
                                        {order.payment_method === "cash"
                                            ? "üíµ EFECTIVO"
                                            : "üí≥ ONLINE"}
                                    </p>
                                </div>
                            </div>

                            {/* 4. Product List (Compact) */}
                            <div class="w-full lg:w-56 flex-shrink-0">
                                <span class="text-[9px] font-black text-gray-600 uppercase tracking-widest block mb-3">
                                    Productos
                                </span>
                                <ul class="space-y-2">
                                    {order.order_items?.map((item: any) => (
                                        <li class="flex items-center gap-3 group/item">
                                            <span class="w-7 h-7 flex-shrink-0 flex items-center justify-center rounded-lg bg-white/5 border border-white/10 text-[10px] font-black text-white leading-none">
                                                {item.quantity}
                                            </span>
                                            <span class="text-[11px] font-bold text-gray-400 group-hover/item:text-white transition-colors truncate italic">
                                                {item.product_name ||
                                                    item.product?.name ||
                                                    "Producto"}
                                                {item.size && (
                                                    <span class="text-gray-600 text-[9px] ml-1 font-black">
                                                        [{item.size}]
                                                    </span>
                                                )}
                                            </span>
                                        </li>
                                    ))}
                                </ul>
                            </div>

                            {/* 5. Progress Stepper - THE HERO */}
                            <div class="flex-1 w-full lg:min-w-[200px]">
                                <div class="mb-5 flex justify-between items-end">
                                    <span
                                        id={`status-label-${order.id}`}
                                        class="status-label text-[10px] font-black uppercase tracking-widest transition-colors duration-500"
                                        style={{
                                            color: statusColors[
                                                order.status as keyof typeof statusColors
                                            ],
                                        }}
                                    >
                                        Progreso del Pedido
                                    </span>
                                    <span
                                        id={`progress-text-${order.id}`}
                                        class="progress-text text-[10px] font-black uppercase tracking-widest text-gray-600 italic"
                                    >
                                        {!isCancelled
                                            ? `${Math.round(((currentStatusIndex + 1) / 4) * 100)}% Completado`
                                            : "CANCELADO"}
                                    </span>
                                </div>

                                <div class="relative flex items-center justify-between">
                                    {/* Connector Background */}
                                    <div class="absolute left-0 right-0 h-1 bg-gray-800/50 rounded-full" />
                                    {/* Connector Progress */}
                                    <div
                                        id={`progress-line-${order.id}`}
                                        class="progress-line absolute left-0 h-1 transition-all duration-1000 rounded-full"
                                        style={
                                            !isCancelled
                                                ? {
                                                      width: `${(currentStatusIndex / (statusFlow.length - 1)) * 100}%`,
                                                      backgroundColor:
                                                          statusColors[
                                                              order.status as keyof typeof statusColors
                                                          ],
                                                      boxShadow: `0 0 15px ${statusColors[order.status as keyof typeof statusColors]}80`,
                                                  }
                                                : {
                                                      width: "100%",
                                                      backgroundColor:
                                                          statusColors.cancelled,
                                                      boxShadow: `0 0 15px ${statusColors.cancelled}80`,
                                                      opacity: "0.3",
                                                  }
                                        }
                                    />

                                    {statusFlow.map((s, idx) => (
                                        <div
                                            class={`relative z-10 flex flex-col items-center ${isCancelled ? "opacity-30" : ""}`}
                                        >
                                            <div
                                                id={`status-dot-${order.id}-${s}`}
                                                class="status-dot w-6 h-6 rounded-full border-4 transition-all duration-700 flex items-center justify-center"
                                                style={
                                                    !isCancelled &&
                                                    idx <= currentStatusIndex
                                                        ? {
                                                              backgroundColor:
                                                                  statusColors[
                                                                      s as keyof typeof statusColors
                                                                  ],
                                                              borderColor:
                                                                  "#0f1117",
                                                              boxShadow: `0 0 20px ${statusColors[s as keyof typeof statusColors]}60`,
                                                              transform:
                                                                  "scale(1.1)",
                                                          }
                                                        : {
                                                              backgroundColor:
                                                                  "#1f2937",
                                                              borderColor:
                                                                  "#0f1117",
                                                          }
                                                }
                                            >
                                                {!isCancelled &&
                                                    idx <
                                                        currentStatusIndex && (
                                                        <svg
                                                            xmlns="http://www.w3.org/2000/svg"
                                                            width="10"
                                                            height="10"
                                                            viewBox="0 0 24 24"
                                                            fill="none"
                                                            stroke="black"
                                                            stroke-width="4"
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                        >
                                                            <path d="M20 6 9 17l-5-5" />
                                                        </svg>
                                                    )}
                                            </div>
                                            <span
                                                id={`status-text-${order.id}-${s}`}
                                                class={`status-text absolute top-8 text-[8px] font-black uppercase tracking-tighter whitespace-nowrap transition-colors duration-500 ${!isCancelled && idx <= currentStatusIndex ? "text-white" : "text-gray-700"}`}
                                            >
                                                {s === "pending"
                                                    ? "Recibido"
                                                    : s === "paid"
                                                      ? "Pagado"
                                                      : s === "shipped"
                                                        ? "Enviado"
                                                        : "Listo"}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* 5. Total & Actions */}
                            <div class="w-full 2xl:w-48 flex-shrink-0 flex flex-row 2xl:flex-col items-center 2xl:items-end justify-between 2xl:justify-center gap-6 border-t 2xl:border-t-0 2xl:border-l border-white/5 pt-6 2xl:pt-0 2xl:pl-10">
                                <div class="text-right">
                                    <p class="text-gray-600 text-[10px] font-black uppercase tracking-widest mb-1">
                                        Total
                                    </p>
                                    <p class="text-3xl font-black text-white italic tracking-tighter">
                                        {formatPrice(
                                            order.total_amount ||
                                                order.total_price,
                                        )}
                                    </p>
                                </div>
                                <div class="flex flex-col gap-4 w-full max-w-[160px]">
                                    <StatusSelect
                                        client:load
                                        id={order.id}
                                        initialStatus={order.status}
                                    />
                                    <div class="flex gap-2">
                                        {!isPickup && (
                                            <button
                                                type="button"
                                                class="shipping-btn flex-1 h-12 flex items-center justify-center rounded-2xl bg-white/5 hover:bg-white text-white hover:text-black transition-all duration-300 border border-white/5 text-xl shadow-lg hover:shadow-white/10 active:scale-95"
                                                data-id={order.id}
                                                data-address={JSON.stringify(
                                                    address,
                                                )}
                                                title="Ver direcci√≥n"
                                            >
                                                üó∫Ô∏è
                                            </button>
                                        )}
                                        {contact.phone && (
                                            <a
                                                href={`tel:${contact.phone}`}
                                                class="flex-1 h-12 flex items-center justify-center rounded-2xl bg-white/5 hover:bg-white text-white hover:text-black transition-all duration-300 border border-white/5 text-xl shadow-lg hover:shadow-white/10 active:scale-95"
                                                title="Llamar"
                                            >
                                                üìû
                                            </a>
                                        )}
                                        <a
                                            href={`/admin/orders/invoice/${order.id}`}
                                            target="_blank"
                                            class="flex-1 h-12 flex items-center justify-center rounded-2xl bg-white/5 hover:bg-white text-white hover:text-black transition-all duration-300 border border-white/5 text-xl shadow-lg hover:shadow-white/10 active:scale-95"
                                            title="Descargar Factura"
                                        >
                                            üìÑ
                                        </a>
                                        <button
                                            data-email={
                                                contact.email ||
                                                order.guest_email
                                            }
                                            data-order-id={order.id}
                                            data-status={order.status}
                                            data-type="manual"
                                            class="email-btn flex-1 h-12 flex items-center justify-center rounded-2xl bg-white/5 hover:bg-white text-white hover:text-black transition-all duration-300 border border-white/5 text-xl shadow-lg hover:shadow-white/10 active:scale-95"
                                            title="Enviar Email"
                                        >
                                            üìß
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            })
        }

        {
            (!orders || orders.length === 0) && (
                <div class="text-center py-32 bg-gray-900/30 rounded-[3rem] border border-dashed border-white/10">
                    <div class="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-8 animate-pulse text-4xl">
                        üõí
                    </div>
                    <h2 class="text-2xl font-black text-white italic uppercase mb-2">
                        Buscamos registros...
                    </h2>
                    <p class="text-gray-500 font-bold uppercase tracking-widest text-xs">
                        No se han encontrado pedidos con este criterio
                    </p>
                    <a
                        href="/admin/orders"
                        class="inline-block mt-8 text-[10px] font-black text-white border-b-2 border-white/10 hover:border-white transition-all pb-1 uppercase tracking-widest"
                    >
                        Ver todos los pedidos
                    </a>
                </div>
            )
        }
    </div>

    <EmailModal client:only="react" />

    <script>
        // Handle clicks on email buttons
        document.addEventListener("click", (e) => {
            const target = (e.target as HTMLElement).closest(".email-btn");
            if (target) {
                console.log("Email button clicked");
                const btn = target as HTMLElement;
                const email = btn.dataset.email;
                const orderId = btn.dataset.orderId;
                const status = btn.dataset.status;
                const type = btn.dataset.type || "manual";
                const firstName = btn.dataset.firstName || "Cliente";

                if (email && orderId) {
                    console.log("Dispatching open-email-modal event", {
                        email,
                        orderId,
                        status,
                        type,
                        firstName,
                    });
                    // Dispatch custom event directly instead of importing helper
                    const event = new CustomEvent("open-email-modal", {
                        detail: {
                            to: email,
                            orderId,
                            status: status || "pending",
                            type,
                            firstName,
                        },
                    });
                    window.dispatchEvent(event);
                } else {
                    console.error("Missing email or orderId data attributes");
                }
            }
        });

        // Listen for status updates from StatusSelect component
        window.addEventListener("order-status-updated", ((e: CustomEvent) => {
            const { orderId, status } = e.detail;

            // 1. Update Email Button Data
            const btn = document.querySelector(
                `.email-btn[data-order-id="${orderId}"]`,
            ) as HTMLElement;
            if (btn) btn.dataset.status = status;

            // 2. Update Stepper Logic
            const flow = ["pending", "paid", "shipped", "completed"];
            const colors: Record<string, string> = {
                pending: "#3b82f6",
                paid: "#22c55e",
                shipped: "#8b5cf6",
                completed: "#f59e0b",
                cancelled: "#ef4444",
            };

            const isCancelled = status === "cancelled";
            const statusIdx = flow.indexOf(status);

            // Update Percentage Text
            const progressText = document.getElementById(
                `progress-text-${orderId}`,
            );
            if (progressText) {
                progressText.innerText = isCancelled
                    ? "CANCELADO"
                    : `${Math.round(((statusIdx + 1) / 4) * 100)}% Completado`;
            }

            // Update Label Color
            const label = document.getElementById(`status-label-${orderId}`);
            if (label) label.style.color = colors[status];

            // Update Progress Line
            const line = document.getElementById(`progress-line-${orderId}`);
            if (line) {
                if (isCancelled) {
                    line.style.width = "100%";
                    line.style.backgroundColor = colors.cancelled;
                    line.style.boxShadow = `0 0 15px ${colors.cancelled}80`;
                    line.style.opacity = "0.3";
                } else {
                    const width = (statusIdx / (flow.length - 1)) * 100;
                    line.style.width = `${width}%`;
                    line.style.backgroundColor = colors[status];
                    line.style.boxShadow = `0 0 15px ${colors[status]}80`;
                    line.style.opacity = "1";
                }
            }

            // Update Dots Opacity and State
            flow.forEach((s, idx) => {
                const dot = document.getElementById(
                    `status-dot-${orderId}-${s}`,
                );
                const text = document.getElementById(
                    `status-text-${orderId}-${s}`,
                );
                const dotContainer = dot?.parentElement;

                if (dotContainer) {
                    dotContainer.style.opacity = isCancelled ? "0.3" : "1";
                }

                if (dot && !isCancelled) {
                    if (idx <= statusIdx) {
                        dot.style.backgroundColor = colors[s];
                        dot.style.boxShadow = `0 0 20px ${colors[s]}60`;
                        dot.style.transform = "scale(1.1)";
                        if (idx < statusIdx && !dot.querySelector("svg")) {
                            dot.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 6 9 17l-5-5" />
                            </svg>
                        `;
                        } else if (idx === statusIdx) {
                            dot.innerHTML = "";
                        }
                    } else {
                        dot.style.backgroundColor = "#1f2937";
                        dot.style.boxShadow = "none";
                        dot.style.transform = "scale(1)";
                        dot.innerHTML = "";
                    }
                } else if (dot && isCancelled) {
                    dot.style.backgroundColor = "#1f2937";
                    dot.style.boxShadow = "none";
                    dot.style.transform = "scale(1)";
                    dot.innerHTML = "";
                }

                if (text) {
                    text.className = `status-text absolute top-8 text-[8px] font-black uppercase tracking-tighter whitespace-nowrap transition-colors duration-500 ${!isCancelled && idx <= statusIdx ? "text-white" : "text-gray-700"}`;
                }
            });
        }) as EventListener);

        // 4. Shipping Modal Dispatcher
        document.addEventListener("click", (e) => {
            const btn = (e.target as HTMLElement).closest(".shipping-btn");
            if (btn) {
                const orderId = btn.getAttribute("data-id")!;
                const addressRaw = btn.getAttribute("data-address")!;

                try {
                    const address = JSON.parse(addressRaw);
                    // Dispatch custom event for ShippingModal.tsx
                    const event = new CustomEvent("open-shipping-modal", {
                        detail: { address, orderId },
                    });
                    window.dispatchEvent(event);
                } catch (err) {
                    console.error("Error parsing address JSON:", err);
                }
            }
        });
    </script>
</AdminLayout>
