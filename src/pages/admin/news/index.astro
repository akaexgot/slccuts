---
export const prerender = false;

import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

// Fetch news
const { data: news, error } = await supabase
    .from("news")
    .select("*")
    .order("created_at", { ascending: false });

if (error) {
    console.error("Error fetching news:", error);
}

const formatDate = (dateStr: string) => {
    return new Date(dateStr).toLocaleDateString("es-ES", {
        day: "2-digit",
        month: "long",
        year: "numeric",
    });
};
---

<AdminLayout title="Gestionar Noticias" activeSection="news">
    <div class="flex justify-between items-center mb-10">
        <div>
            <h2 class="text-3xl font-bold text-white">Publicaciones</h2>
            <p class="text-gray-400 mt-1">
                Gestiona las noticias y novedades de tu tienda
            </p>
        </div>
        <button
            type="button"
            id="openNewsModal"
            class="bg-pink-600 hover:bg-pink-700 text-white px-6 py-3 rounded-xl font-bold uppercase tracking-wider transition-all shadow-lg shadow-pink-500/20 active:scale-95 flex items-center gap-2"
        >
            <span>+</span> Nueva Publicaci√≥n
        </button>
    </div>

    <div class="grid grid-cols-1 gap-6">
        {
            news && news.length > 0 ? (
                news.map((item: any) => (
                    <div class="bg-gray-800/50 border border-white/5 rounded-[2rem] p-6 flex flex-col md:flex-row gap-8 items-center group hover:bg-gray-800 transition-all duration-500">
                        {/* Image Preview */}
                        <div class="w-full md:w-64 h-48 rounded-2xl overflow-hidden bg-black flex-shrink-0 border border-white/10 shadow-2xl relative">
                            {item.image_url ? (
                                <img
                                    src={item.image_url}
                                    alt={item.title}
                                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                                />
                            ) : (
                                <div class="w-full h-full flex items-center justify-center text-gray-700 text-4xl">
                                    üì∏
                                </div>
                            )}
                            <div class="absolute top-4 left-4">
                                <span
                                    class={`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest ${item.is_published ? "bg-green-500 text-black" : "bg-gray-700 text-white"}`}
                                >
                                    {item.is_published
                                        ? "Publicado"
                                        : "Borrador"}
                                </span>
                            </div>
                        </div>

                        {/* Content */}
                        <div class="flex-1">
                            <span class="text-[10px] font-black text-pink-500 uppercase tracking-[0.2em] block mb-2">
                                {formatDate(item.created_at)}
                            </span>
                            <h3 class="text-2xl font-black text-white italic uppercase mb-4 group-hover:text-pink-400 transition-colors">
                                {item.title}
                            </h3>
                            <p class="text-gray-400 text-sm line-clamp-3 mb-6 leading-relaxed">
                                {item.content}
                            </p>

                            <div class="flex items-center gap-4">
                                <button
                                    class="edit-news-btn text-xs font-black uppercase tracking-widest text-pink-500 hover:text-pink-400 transition-colors flex items-center gap-2"
                                    data-item={JSON.stringify(item)}
                                >
                                    <span>‚úèÔ∏è</span> Editar
                                </button>
                                <span class="w-1 h-1 bg-gray-700 rounded-full" />
                                <button
                                    class="delete-news-btn text-xs font-black uppercase tracking-widest text-red-500 hover:text-red-400 transition-colors flex items-center gap-2"
                                    data-id={item.id}
                                    data-title={item.title}
                                >
                                    <span>üóëÔ∏è</span> Eliminar
                                </button>
                                <span class="w-1 h-1 bg-gray-700 rounded-full" />
                                <a
                                    href={`/news/${item.slug}`}
                                    target="_blank"
                                    class="text-xs font-black uppercase tracking-widest text-blue-400 hover:text-blue-300 transition-colors flex items-center gap-2"
                                >
                                    <span>üëÅÔ∏è</span> Ver en la web
                                </a>
                            </div>
                        </div>
                    </div>
                ))
            ) : (
                <div class="text-center py-20 bg-gray-900/30 rounded-[3rem] border border-dashed border-white/10">
                    <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl">
                        üì∞
                    </div>
                    <h3 class="text-xl font-bold text-white uppercase italic">
                        No hay publicaciones
                    </h3>
                    <p class="text-gray-500 mt-2">
                        Empieza creando tu primera noticia para la web.
                    </p>
                </div>
            )
        }
    </div>

    <!-- The Modal will be added here or in the layout if global -->
    <div
        id="newsModal"
        class="fixed inset-0 z-50 hidden items-center justify-center"
    >
        <div
            class="absolute inset-0 bg-black/80 backdrop-blur-sm"
            data-close-modal
        >
        </div>
        <div
            class="relative bg-gray-900 border border-gray-700 rounded-2xl p-8 max-w-2xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto"
        >
            <button
                type="button"
                class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl"
                data-close-modal>√ó</button
            >

            <h3
                id="modalTitle"
                class="text-3xl font-black uppercase tracking-tighter italic mb-8"
            >
                Nueva Publicaci√≥n
            </h3>

            <form id="newsForm" class="space-y-6">
                <input type="hidden" name="id" id="newsIdInput" />
                <div>
                    <label
                        class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-3"
                        >T√≠tulo de la Noticia *</label
                    >
                    <input
                        type="text"
                        name="title"
                        required
                        class="w-full bg-gray-800 border border-white/5 rounded-xl px-4 py-4 text-white focus:border-pink-500/50 focus:outline-none transition-colors italic font-bold"
                        placeholder="Ej: ¬°Nueva Apertura este S√°bado!"
                    />
                </div>

                <div>
                    <label
                        class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-3"
                        >Slug (para la URL) *</label
                    >
                    <input
                        type="text"
                        name="slug"
                        required
                        class="w-full bg-gray-800 border border-white/5 rounded-xl px-4 py-3 text-white focus:border-pink-500/50 focus:outline-none transition-colors font-mono text-sm"
                        placeholder="ej-nueva-apertura"
                    />
                </div>

                <div>
                    <label
                        class="block text-[10px] font-black uppercase tracking-widest text-gray-500 mb-3"
                        >Contenido de la Publicaci√≥n *</label
                    >
                    <textarea
                        name="content"
                        required
                        rows="6"
                        class="w-full bg-gray-800 border border-white/5 rounded-xl px-4 py-4 text-white focus:border-pink-500/50 focus:outline-none transition-colors resize-none leading-relaxed"
                        placeholder="Escribe aqu√≠ el texto completo..."
                    ></textarea>
                </div>

                {/* News Image Upload */}
                <div class="space-y-3">
                    <label
                        class="block text-[10px] font-black uppercase tracking-widest text-gray-500"
                        >Imagen de Portada</label
                    >
                    <input
                        type="hidden"
                        name="image_url"
                        id="newsFormImageUrl"
                    />

                    <div
                        id="newsDropZone"
                        class="border-2 border-dashed border-white/10 rounded-2xl p-8 text-center cursor-pointer hover:border-pink-500/30 hover:bg-white/5 transition-all group"
                    >
                        <div class="space-y-3">
                            <div
                                class="text-4xl group-hover:scale-110 transition-transform"
                            >
                                üì∏
                            </div>
                            <p
                                class="text-sm text-gray-400 font-bold uppercase tracking-widest"
                            >
                                Arrastra o haz clic
                            </p>
                        </div>
                    </div>

                    <div
                        id="newsImagePreviewContainer"
                        class="hidden relative group rounded-2xl overflow-hidden border border-white/10 aspect-video bg-black shadow-2xl"
                    >
                        <img
                            id="newsImagePreview"
                            src=""
                            class="w-full h-full object-cover"
                        />
                        <div
                            class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4"
                        >
                            <button
                                type="button"
                                id="removeNewsImage"
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-colors shadow-lg"
                                >Eliminar</button
                            >
                        </div>
                    </div>

                    <div id="newsUploadProgress" class="hidden">
                        <div
                            class="h-1 w-full bg-gray-800 rounded-full overflow-hidden"
                        >
                            <div
                                class="h-full bg-pink-500 animate-pulse w-full"
                            >
                            </div>
                        </div>
                    </div>

                    <input
                        type="file"
                        id="newsFileInput"
                        class="hidden"
                        accept="image/*"
                    />
                </div>

                <button
                    type="submit"
                    id="submitBtn"
                    class="w-full bg-white text-black font-black uppercase tracking-[0.2em] py-5 rounded-2xl shadow-xl hover:shadow-white/10 active:scale-[0.98] transition-all"
                >
                    Publicar Ahora
                </button>
            </form>
        </div>
    </div>

    <!-- Custom Delete Modal -->
    <div
        id="deleteModal"
        class="fixed inset-0 z-[60] hidden items-center justify-center"
    >
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md"></div>
        <div
            class="relative bg-gray-900 border border-white/10 rounded-[2.5rem] p-10 max-w-md w-full mx-4 shadow-2xl text-center transform transition-all"
        >
            <div
                class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6"
            >
                <span class="text-4xl">üóëÔ∏è</span>
            </div>
            <h3
                class="text-2xl font-black uppercase italic tracking-tighter text-white mb-2"
            >
                ¬øEst√°s seguro?
            </h3>
            <p class="text-gray-400 mb-8 leading-relaxed">
                Vas a eliminar <span
                    id="deleteItemTitle"
                    class="text-white font-bold">esta noticia</span
                > de forma permanente. Esta acci√≥n no se puede deshacer.
            </p>

            <div class="flex flex-col gap-3">
                <button
                    id="confirmDeleteBtn"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-black uppercase tracking-widest py-4 rounded-2xl transition-all active:scale-95"
                >
                    S√≠, Eliminar Permanentemente
                </button>
                <button
                    id="cancelDeleteBtn"
                    class="w-full bg-white/5 hover:bg-white/10 text-gray-400 font-black uppercase tracking-widest py-4 rounded-2xl transition-all"
                >
                    No, Mantener Noticia
                </button>
            </div>
        </div>
    </div>
</AdminLayout>

<script>
    import { supabase } from "../../../lib/supabase";

    // Modal Logic
    const openBtn = document.getElementById("openNewsModal");
    const modal = document.getElementById("newsModal");
    const modalTitle = document.getElementById("modalTitle");
    const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
    const closeBtns = document.querySelectorAll("[data-close-modal]");
    const form = document.getElementById("newsForm") as HTMLFormElement;
    const newsIdInput = document.getElementById(
        "newsIdInput",
    ) as HTMLInputElement;

    openBtn?.addEventListener("click", () => {
        newsIdInput.value = "";
        if (modalTitle) modalTitle.innerText = "Nueva Publicaci√≥n";
        if (submitBtn) submitBtn.innerText = "Publicar Ahora";
        modal?.classList.remove("hidden");
        modal?.classList.add("flex");
        document.body.style.overflow = "hidden";
    });

    const closeModal = () => {
        modal?.classList.add("hidden");
        modal?.classList.remove("flex");
        document.body.style.overflow = "auto";
        form?.reset();
        document
            .getElementById("newsImagePreviewContainer")
            ?.classList.add("hidden");
        document.getElementById("newsDropZone")?.classList.remove("hidden");
        (
            document.getElementById("newsFormImageUrl") as HTMLInputElement
        ).value = "";
    };

    closeBtns.forEach((btn) => btn.addEventListener("click", closeModal));

    // Edit Logic (Event Delegation)
    document.addEventListener("click", (e) => {
        const btn = (e.target as HTMLElement).closest(
            ".edit-news-btn",
        ) as HTMLButtonElement;
        if (!btn) return;

        try {
            const dataAttr = btn.getAttribute("data-item");
            if (!dataAttr) return;
            const item = JSON.parse(dataAttr);

            // Populate form
            if (newsIdInput) newsIdInput.value = item.id;

            const titleField = form.querySelector(
                'input[name="title"]',
            ) as HTMLInputElement;
            const slugField = form.querySelector(
                'input[name="slug"]',
            ) as HTMLInputElement;
            const contentField = form.querySelector(
                'textarea[name="content"]',
            ) as HTMLTextAreaElement;
            const imgUrlField = form.querySelector(
                'input[name="image_url"]',
            ) as HTMLInputElement;

            if (titleField) titleField.value = item.title;
            if (slugField) slugField.value = item.slug;
            if (contentField) contentField.value = item.content;
            if (imgUrlField) imgUrlField.value = item.image_url || "";

            if (item.image_url) {
                const previewImg = document.getElementById(
                    "newsImagePreview",
                ) as HTMLImageElement;
                const previewContainer = document.getElementById(
                    "newsImagePreviewContainer",
                );
                const dropZone = document.getElementById("newsDropZone");

                if (previewImg) previewImg.src = item.image_url;
                previewContainer?.classList.remove("hidden");
                dropZone?.classList.add("hidden");
            } else {
                document
                    .getElementById("newsImagePreviewContainer")
                    ?.classList.add("hidden");
                document
                    .getElementById("newsDropZone")
                    ?.classList.remove("hidden");
            }

            if (modalTitle) modalTitle.innerText = "Editar Publicaci√≥n";
            if (submitBtn) submitBtn.innerText = "Guardar Cambios";

            modal?.classList.remove("hidden");
            modal?.classList.add("flex");
            document.body.style.overflow = "hidden";
        } catch (err) {
            console.error("Error opening edit modal:", err);
        }
    });

    // Slug Auto-generation
    const titleInput = form?.querySelector(
        'input[name="title"]',
    ) as HTMLInputElement;
    const slugInput = form?.querySelector(
        'input[name="slug"]',
    ) as HTMLInputElement;

    titleInput?.addEventListener("input", (e) => {
        if (newsIdInput.value) return; // Don't auto-slug when editing
        const val = (e.target as HTMLInputElement).value;
        slugInput.value = val
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/^-+|-+$/g, "");
    });

    // Image Upload Logic
    const dropZone = document.getElementById("newsDropZone");
    const fileInput = document.getElementById(
        "newsFileInput",
    ) as HTMLInputElement;
    const previewContainer = document.getElementById(
        "newsImagePreviewContainer",
    );
    const previewImg = document.getElementById(
        "newsImagePreview",
    ) as HTMLImageElement;
    const progress = document.getElementById("newsUploadProgress");
    const hiddenUrlInput = document.getElementById(
        "newsFormImageUrl",
    ) as HTMLInputElement;
    const removeImgBtn = document.getElementById("removeNewsImage");

    dropZone?.addEventListener("click", () => fileInput.click());

    fileInput?.addEventListener("change", async (e) => {
        const files = (e.target as HTMLInputElement).files;
        if (!files || files.length === 0) return;

        const file = files[0];
        const fileExt = file.name.split(".").pop();
        const fileName = `${Math.random()}.${fileExt}`;
        const filePath = `news/${fileName}`;

        try {
            dropZone?.classList.add("hidden");
            progress?.classList.remove("hidden");

            const { error: uploadError } = await supabase.storage
                .from("news")
                .upload(filePath, file);

            if (uploadError) throw uploadError;

            const {
                data: { publicUrl },
            } = supabase.storage.from("news").getPublicUrl(filePath);

            hiddenUrlInput.value = publicUrl;
            previewImg.src = publicUrl;
            previewContainer?.classList.remove("hidden");
            window.showToast("√âxito", "Imagen subida correctamente", "success");
        } catch (error) {
            console.error("Full upload error:", error);
            const errorMessage =
                error instanceof Error ? error.message : "Error desconocido";
            window.showToast(
                "Error",
                `Error al subir la imagen: ${errorMessage}`,
                "error",
            );
            dropZone?.classList.remove("hidden");
        } finally {
            progress?.classList.add("hidden");
        }
    });

    removeImgBtn?.addEventListener("click", () => {
        hiddenUrlInput.value = "";
        previewContainer?.classList.add("hidden");
        dropZone?.classList.remove("hidden");
        fileInput.value = "";
    });

    // Form Submission
    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerText = "Guardando...";

        const formData = new FormData(form);
        const id = formData.get("id");
        const data: any = {
            title: formData.get("title"),
            slug: formData.get("slug"),
            content: formData.get("content"),
            image_url: formData.get("image_url"),
            is_published: true,
        };

        try {
            if (id) {
                const { error } = await supabase
                    .from("news")
                    .update(data)
                    .eq("id", id);
                if (error) throw error;
            } else {
                const { error } = await supabase.from("news").insert([data]);
                if (error) throw error;
            }
            window.showToast(
                "√âxito",
                "Noticia guardada correctamente",
                "success",
            );
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            console.error("Database Error:", error);
            const errorMessage =
                error instanceof Error ? error.message : "Error desconocido";
            window.showToast(
                "Error",
                `Error al guardar: ${errorMessage}`,
                "error",
            );
            submitBtn.disabled = false;
            submitBtn.innerText = id ? "Guardar Cambios" : "Publicar Ahora";
        }
    });

    // Delete Logic (Stylish Modal)
    const deleteModal = document.getElementById("deleteModal");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
    const deleteItemTitle = document.getElementById("deleteItemTitle");
    let itemToDeleteId: string | null = null;

    document.querySelectorAll(".delete-news-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            const title = btn.getAttribute("data-title");
            if (!id) return;

            itemToDeleteId = id;
            if (deleteItemTitle)
                deleteItemTitle.innerText = title || "esta noticia";

            deleteModal?.classList.remove("hidden");
            deleteModal?.classList.add("flex");
            document.body.style.overflow = "hidden";
        });
    });

    cancelDeleteBtn?.addEventListener("click", () => {
        deleteModal?.classList.add("hidden");
        deleteModal?.classList.remove("flex");
        document.body.style.overflow = "auto";
        itemToDeleteId = null;
    });

    confirmDeleteBtn?.addEventListener("click", async () => {
        if (!itemToDeleteId) return;

        const originalText = confirmDeleteBtn.innerText;
        (confirmDeleteBtn as HTMLButtonElement).disabled = true;
        confirmDeleteBtn.innerText = "Eliminando...";

        try {
            const { error } = await supabase
                .from("news")
                .delete()
                .eq("id", itemToDeleteId);
            if (error) throw error;
            window.showToast(
                "√âxito",
                "Noticia eliminada correctamente",
                "success",
            );
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            console.error("Error deleting news:", error);
            window.showToast("Error", "Error al eliminar la noticia", "error");
            (confirmDeleteBtn as HTMLButtonElement).disabled = false;
            confirmDeleteBtn.innerText = originalText;
        }
    });
</script>
