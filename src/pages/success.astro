---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import Stripe from "stripe";
import { supabase } from "../lib/supabase";

import {
    orderConfirmationTemplate,
    orderConfirmationText,
} from "../lib/email-templates";

const method = Astro.url.searchParams.get("method") || "delivery";
const isPickup = method === "pickup";
const sessionId = Astro.url.searchParams.get("session_id");
const orderId = Astro.url.searchParams.get("order_id");

// Verify Payment if session_id is present
if (sessionId && orderId) {
    try {
        const stripe = new Stripe(import.meta.env.STRIPE_SECRET_KEY);

        const session = await stripe.checkout.sessions.retrieve(sessionId);

        if (session.payment_status === "paid") {
            const { data: order } = await supabase
                .from("orders")
                .update({ status: "paid" })
                .eq("id", orderId)
                .select("*, order_items(*, product:products(*))")
                .single();

            if (order && !order.confirmation_email_sent) {
                // Send confirmation emails
                try {
                    const protocol = Astro.url.protocol;
                    const host = Astro.url.host;
                    const baseUrl = `${protocol}//${host}`;

                    const contact = order.contact_info || {};
                    const email = contact.email || order.guest_email;

                    // 1. Send customer confirmation email
                    if (email) {
                        await fetch(`${baseUrl}/api/emails/send`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                to: email,
                                subject: `Confirmaci√≥n de tu pedido #${order.id.slice(0, 8)} - SLC CUTS`,
                                html: orderConfirmationTemplate(order),
                                text: orderConfirmationText(order),
                            }),
                        });
                    }

                    // 2. Send ADMIN notification email
                    try {
                        const {
                            adminOrderNotificationTemplate,
                            adminOrderNotificationText,
                        } = await import("../lib/email-templates");

                        await fetch(`${baseUrl}/api/emails/send`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                to: "slccuts1998@gmail.com",
                                subject: `üî• NUEVO PEDIDO PAGADO #${order.id.slice(0, 8).toUpperCase()}`,
                                html: adminOrderNotificationTemplate(order),
                                text: adminOrderNotificationText(order),
                            }),
                        });
                    } catch (adminEmailError) {
                        console.error(
                            "Error sending admin notification:",
                            adminEmailError,
                        );
                    }

                    // Mark as sent in DB
                    await supabase
                        .from("orders")
                        .update({ confirmation_email_sent: true })
                        .eq("id", orderId);
                } catch (emailError) {
                    console.error(
                        "Error sending automatic emails:",
                        emailError,
                    );
                }
            }
        }
    } catch (error) {
        console.error("Error verifying payment:", error);
    }
}
---

<Layout title="Pedido Confirmado | SLC CUTS">
    <div class="container mx-auto px-4 py-20 text-center max-w-2xl">
        <div
            class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-green-600"
                ><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline
                    points="22 4 12 14.01 9 11.01"></polyline></svg
            >
        </div>

        <h1 class="text-4xl font-bold mb-4 uppercase tracking-wider">
            ¬°Pedido Confirmado!
        </h1>

        {
            isPickup ? (
                <div class="space-y-4 mb-8">
                    <p class="text-xl font-bold text-gray-800">
                        Tu pedido estar√° listo en breve.
                    </p>
                    <p class="text-gray-600">
                        Gracias por tu compra. Te enviaremos un{" "}
                        <strong>correo electr√≥nico de confirmaci√≥n</strong> con
                        todos los detalles.
                    </p>
                    <div class="bg-gray-50 p-4 rounded-lg inline-block text-left text-sm mt-4">
                        <p class="font-bold mb-1">Punto de Recogida:</p>
                        <p>SLC CUTS Barber√≠a</p>
                        <p>C. Miguel de Cervantes, 79</p>
                        <p>11550 Chipiona, C√°diz</p>
                    </div>
                </div>
            ) : (
                <p class="text-gray-600 text-lg mb-8">
                    Muchas gracias por tu compra. Hemos recibido tu pedido
                    correctamente y te enviaremos un email de confirmaci√≥n en
                    breve.
                </p>
            )
        }

        <div
            class="bg-gray-50 p-6 rounded-xl border border-gray-100 mb-8 text-left"
        >
            <h3
                class="font-bold mb-2 uppercase text-sm tracking-widest text-gray-500"
            >
                Siguientes pasos
            </h3>
            <ul class="space-y-3 text-sm">
                <li class="flex items-start gap-3">
                    <span
                        class="bg-black text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs mt-0.5"
                        >1</span
                    >
                    <span
                        >Revisa tu email (incluyendo Spam) para ver el ticket de
                        compra.</span
                    >
                </li>
                <li class="flex items-start gap-3">
                    <span
                        class="bg-black text-white w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs mt-0.5"
                        >2</span
                    >
                    <span>
                        {
                            isPickup
                                ? "Te avisaremos (por email o tel√©fono) cuando tu pedido est√© listo para recoger."
                                : "Recibir√°s un n√∫mero de seguimiento cuando el pedido salga del almac√©n."
                        }
                    </span>
                </li>
            </ul>
        </div>

        <a
            href="/shop/new"
            class="inline-block bg-black text-white px-8 py-4 rounded-lg font-bold uppercase tracking-widest hover:bg-gray-800 transition-colors"
        >
            Volver a la Tienda
        </a>
    </div>
</Layout>
