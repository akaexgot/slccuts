---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Restablecer Contraseña">
    <div class="min-h-[80vh] flex items-center justify-center py-12 px-4">
        <div class="w-full max-w-md space-y-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold tracking-tight text-gray-900">
                    Nueva Contraseña
                </h2>
                <p class="mt-2 text-sm text-gray-600">
                    Introduce tu nueva contraseña a continuación.
                </p>
            </div>

            <div id="loadingState" class="text-center py-8">
                <p class="text-sm text-gray-500">Verificando enlace...</p>
            </div>

            <div id="errorState" class="hidden text-center py-8">
                <div class="text-red-500 mb-4">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-12 w-12 mx-auto"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">
                    Enlace inválido o expirado
                </h3>
                <p class="mt-2 text-sm text-gray-500">
                    El enlace para restablecer la contraseña no es válido o ha
                    expirado. Por favor, solicita uno nuevo.
                </p>
                <div class="mt-6">
                    <a
                        href="/forgot-password"
                        class="text-sm font-semibold text-black hover:text-gray-700"
                    >
                        Solicitar nuevo enlace &rarr;
                    </a>
                </div>
            </div>

            <form class="mt-8 space-y-6 hidden" id="resetPasswordForm">
                <div class="space-y-4 rounded-md shadow-sm">
                    <div>
                        <label for="password" class="sr-only"
                            >Nueva contraseña</label
                        >
                        <input
                            id="password"
                            name="password"
                            type="password"
                            required
                            minlength="6"
                            class="relative block w-full rounded-lg border-0 py-3 px-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-black sm:text-sm sm:leading-6"
                            placeholder="Nueva contraseña"
                        />
                    </div>
                </div>

                <div
                    id="messageBox"
                    class="hidden text-center text-sm font-medium p-3 rounded-md"
                >
                </div>

                <div>
                    <button
                        type="submit"
                        id="submitBtn"
                        class="group relative flex w-full justify-center rounded-lg bg-black px-3 py-3 text-sm font-semibold text-white hover:bg-gray-800 disabled:opacity-50 transition-colors"
                    >
                        Cambiar Contraseña
                    </button>
                    <div class="mt-4 text-center">
                        <a
                            href="/login"
                            class="text-xs text-gray-500 hover:text-gray-900 transition-colors"
                        >
                            Volver al inicio de sesión
                        </a>
                    </div>
                </div>
            </form>

            <script>
                import { supabase } from "../lib/supabase";

                const form = document.getElementById(
                    "resetPasswordForm",
                ) as HTMLFormElement;
                const messageBox = document.getElementById("messageBox");
                const submitBtn = document.getElementById(
                    "submitBtn",
                ) as HTMLButtonElement;
                const loadingState = document.getElementById("loadingState");
                const errorState = document.getElementById("errorState");

                // Check for session/recovery hash
                supabase.auth.onAuthStateChange(async (event, session) => {
                    loadingState?.classList.add("hidden");

                    if (event === "PASSWORD_RECOVERY" || session) {
                        form?.classList.remove("hidden");
                    } else {
                        // Sometimes the session is not immediately available, or the link is invalid
                        // But onAuthStateChange is reliable for recovery flow start
                        // If no session after a short delay, show error
                        setTimeout(async () => {
                            const { data } = await supabase.auth.getSession();
                            if (!data.session) {
                                errorState?.classList.remove("hidden");
                                form?.classList.add("hidden");
                            } else {
                                form?.classList.remove("hidden");
                                errorState?.classList.add("hidden");
                            }
                        }, 500);
                    }
                });

                form?.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    if (messageBox) {
                        messageBox.classList.add("hidden");
                        messageBox.className =
                            "hidden text-center text-sm font-medium p-3 rounded-md";
                    }
                    submitBtn.disabled = true;
                    submitBtn.innerText = "Actualizando...";

                    const formData = new FormData(form);
                    const password = formData.get("password") as string;

                    try {
                        const { error } = await supabase.auth.updateUser({
                            password: password,
                        });

                        if (error) throw error;

                        if (messageBox) {
                            messageBox.textContent =
                                "Contraseña actualizada correctamente. Redirigiendo...";
                            messageBox.classList.remove("hidden");
                            messageBox.classList.add(
                                "bg-green-50",
                                "text-green-700",
                            );
                        }

                        // Wait a moment before redirecting
                        setTimeout(() => {
                            window.location.href = "/login";
                        }, 2000);
                    } catch (error: any) {
                        console.error("Error:", error);
                        if (messageBox) {
                            messageBox.textContent =
                                error.message ||
                                "Error al actualizar la contraseña.";
                            messageBox.classList.remove("hidden");
                            messageBox.classList.add(
                                "bg-red-50",
                                "text-red-700",
                            );
                        }
                        submitBtn.disabled = false;
                        submitBtn.innerText = "Cambiar Contraseña";
                    }
                });
            </script>
        </div>
    </div>
</Layout>
