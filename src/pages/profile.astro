---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import MosaicBackground from "../components/ui/MosaicBackground.astro";
---

<Layout title="Mi Perfil">
    <div class="relative py-8 min-h-[80vh] overflow-hidden">
        <MosaicBackground mode="light" opacity="opacity-[0.03]" />

        <div class="container mx-auto px-4 max-w-4xl relative z-10">
            <div class="mb-8 md:mb-12 text-center md:text-left">
                <h1
                    class="text-4xl md:text-6xl font-black text-black italic uppercase tracking-tighter mb-4"
                >
                    Mi <span class="text-gray-400">Perfil</span>
                </h1>
                <div class="h-1.5 w-24 md:w-full bg-black mx-auto md:mx-0">
                </div>
            </div>

            <div id="loading" class="text-center py-20">
                <div
                    class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-black"
                >
                </div>
                <p class="text-gray-500 mt-4 text-sm tracking-wide uppercase">
                    Cargando perfil...
                </p>
            </div>

            <div id="profile-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Sidebar / Actions (Mobile: Top) -->
                    <div
                        class="md:col-span-1 space-y-4 order-first md:order-last"
                    >
                        <!-- Welcome Card -->
                        <div
                            class="bg-black text-white p-6 rounded-2xl shadow-xl relative overflow-hidden group"
                        >
                            <div
                                class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-all"
                            >
                            </div>
                            <p
                                class="text-xs text-gray-400 uppercase tracking-widest mb-1"
                            >
                                Bienvenido
                            </p>
                            <h2
                                class="text-2xl font-bold truncate"
                                id="card-name-display"
                            >
                                Usuario
                            </h2>
                        </div>

                        <!-- Action Cards -->
                        <div class="grid grid-cols-2 md:grid-cols-1 gap-4">
                            <a
                                href="/orders"
                                class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all group flex flex-col items-center md:items-start text-center md:text-left gap-3"
                            >
                                <div
                                    class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center group-hover:scale-110 transition-transform"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="text-gray-900"
                                        ><path d="m20.9 18.3-5.1-5.1"
                                        ></path><path
                                            d="M11 5c-3.3 0-6 2.7-6 6s2.7 6 6 6 6-2.7 6-6-2.7-6-6-6Z"
                                        ></path><path d="m11 9 1 1-1 1"
                                        ></path><path d="M12 11h-2"></path></svg
                                    >
                                </div>
                                <div>
                                    <span
                                        class="block font-bold text-gray-900 text-sm"
                                        >Mis Pedidos</span
                                    >
                                    <span class="text-xs text-gray-500"
                                        >Historial y estado</span
                                    >
                                </div>
                            </a>

                            <div id="admin-actions" class="hidden">
                                <a
                                    href="/admin"
                                    class="bg-indigo-600 p-5 rounded-2xl shadow-lg shadow-indigo-200 hover:shadow-xl transition-all group flex flex-col items-center md:items-start text-center md:text-left gap-3 w-full"
                                >
                                    <div
                                        class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center group-hover:scale-110 transition-transform text-white"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            ><rect
                                                width="18"
                                                height="11"
                                                x="3"
                                                y="11"
                                                rx="2"
                                                ry="2"></rect><path
                                                d="M7 11V7a5 5 0 0 1 10 0v4"
                                            ></path></svg
                                        >
                                    </div>
                                    <div>
                                        <span
                                            class="block font-bold text-white text-sm"
                                            >Panel Admin</span
                                        >
                                        <span class="text-xs text-indigo-200"
                                            >Gestión de tienda</span
                                        >
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Main Form -->
                    <div class="md:col-span-2">
                        <div
                            class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100"
                        >
                            <h2
                                class="text-xl font-bold mb-6 flex items-center gap-2"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="text-gray-400"
                                    ><path
                                        d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"
                                    ></path><circle cx="12" cy="7" r="4"
                                    ></circle></svg
                                >
                                Datos Personales
                            </h2>
                            <form id="profile-form" class="space-y-6">
                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 gap-6"
                                >
                                    <div class="space-y-2">
                                        <label
                                            class="text-xs font-bold text-gray-500 uppercase tracking-widest pl-1"
                                            >Nombre</label
                                        >
                                        <input
                                            type="text"
                                            name="first_name"
                                            class="w-full bg-gray-50 border-transparent focus:bg-white focus:border-black focus:ring-0 rounded-xl px-4 py-3 transition-colors font-medium"
                                            placeholder="Tu nombre"
                                        />
                                    </div>
                                    <div class="space-y-2">
                                        <label
                                            class="text-xs font-bold text-gray-500 uppercase tracking-widest pl-1"
                                            >Apellidos</label
                                        >
                                        <input
                                            type="text"
                                            name="last_name"
                                            class="w-full bg-gray-50 border-transparent focus:bg-white focus:border-black focus:ring-0 rounded-xl px-4 py-3 transition-colors font-medium"
                                            placeholder="Tus apellidos"
                                        />
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label
                                        class="text-xs font-bold text-gray-500 uppercase tracking-widest pl-1"
                                        >Email</label
                                    >
                                    <div class="relative">
                                        <input
                                            type="email"
                                            name="email"
                                            disabled
                                            class="w-full bg-gray-100/50 border-transparent text-gray-500 rounded-xl px-4 py-3 cursor-not-allowed font-medium pl-10"
                                        />
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            class="absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400"
                                            ><rect
                                                width="20"
                                                height="16"
                                                x="2"
                                                y="4"
                                                rx="2"></rect><path
                                                d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"
                                            ></path></svg
                                        >
                                    </div>
                                    <p class="text-[10px] text-gray-400 pl-1">
                                        El email no se puede cambiar.
                                    </p>
                                </div>

                                <div class="space-y-2">
                                    <label
                                        class="text-xs font-bold text-gray-500 uppercase tracking-widest pl-1"
                                        >Teléfono</label
                                    >
                                    <input
                                        type="tel"
                                        name="phone"
                                        placeholder="+34 600 000 000"
                                        class="w-full bg-gray-50 border-transparent focus:bg-white focus:border-black focus:ring-0 rounded-xl px-4 py-3 transition-colors font-medium"
                                    />
                                </div>

                                <div
                                    class="pt-6 border-t border-gray-100 flex flex-col md:flex-row md:items-center justify-between gap-4"
                                >
                                    <div
                                        id="form-message"
                                        class="hidden text-sm font-medium px-4 py-2 rounded-lg bg-gray-50"
                                    >
                                    </div>
                                    <button
                                        type="submit"
                                        id="save-btn"
                                        class="bg-black text-white px-8 py-3 rounded-xl font-bold uppercase tracking-wider hover:bg-gray-800 transition-all active:scale-[0.98] shadow-lg shadow-black/20"
                                    >
                                        Guardar Cambios
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div
                id="auth-check-failed"
                class="hidden flex flex-col items-center justify-center py-20 text-center"
            >
                <div
                    class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-6"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="32"
                        height="32"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="text-gray-400"
                        ><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"
                        ></path><circle cx="12" cy="7" r="4"></circle></svg
                    >
                </div>
                <h2 class="text-2xl font-bold mb-2">Inicia Sesión</h2>
                <p class="text-gray-500 mb-8 max-w-xs">
                    Accede a tu perfil para gestionar tus pedidos y datos
                    personales.
                </p>
                <a
                    href="/login"
                    class="bg-black text-white px-8 py-3 rounded-xl font-bold uppercase tracking-wider hover:bg-gray-800 transition-all shadow-lg shadow-black/20"
                    >Iniciar Sesión</a
                >
            </div>
        </div>

        <script>
            import { supabase } from "../lib/supabase";

            const loading = document.getElementById("loading");
            const content = document.getElementById("profile-content");
            const authFailed = document.getElementById("auth-check-failed");
            const form = document.getElementById(
                "profile-form",
            ) as HTMLFormElement;
            const msg = document.getElementById("form-message");
            const saveBtn = document.getElementById(
                "save-btn",
            ) as HTMLButtonElement;

            const cardNameDisplay =
                document.getElementById("card-name-display");

            let userId: string | null = null;

            async function loadProfile() {
                const {
                    data: { session },
                } = await supabase.auth.getSession();

                if (!session) {
                    loading?.classList.add("hidden");
                    authFailed?.classList.remove("hidden");
                    return;
                }

                userId = session.user.id;

                // Fetch profile data
                const { data: profile, error } = await supabase
                    .from("users")
                    .select("*")
                    .eq("id", userId)
                    .single();

                if (error && error.code !== "PGRST116") {
                    // PGRST116 is 'not found' which might happen if sync failed
                    console.error("Error fetching profile:", error);
                }

                // Fill form
                if (form) {
                    (
                        form.querySelector('[name="email"]') as HTMLInputElement
                    ).value = session.user.email || "";

                    let firstName = "";

                    if (profile) {
                        firstName = profile.first_name || "Usuario";
                        (
                            form.querySelector(
                                '[name="first_name"]',
                            ) as HTMLInputElement
                        ).value = profile.first_name || "";
                        (
                            form.querySelector(
                                '[name="last_name"]',
                            ) as HTMLInputElement
                        ).value = profile.last_name || "";
                        (
                            form.querySelector(
                                '[name="phone"]',
                            ) as HTMLInputElement
                        ).value = profile.phone || "";
                    } else {
                        // Try metadata if no profile record
                        firstName =
                            session.user.user_metadata.first_name || "Usuario";
                        (
                            form.querySelector(
                                '[name="first_name"]',
                            ) as HTMLInputElement
                        ).value = session.user.user_metadata.first_name || "";
                        (
                            form.querySelector(
                                '[name="last_name"]',
                            ) as HTMLInputElement
                        ).value = session.user.user_metadata.last_name || "";
                    }

                    if (cardNameDisplay)
                        cardNameDisplay.textContent = firstName;

                    // Check for admin role
                    if (profile && profile.role === "admin") {
                        document
                            .getElementById("admin-actions")
                            ?.classList.remove("hidden");
                    }
                }

                loading?.classList.add("hidden");
                content?.classList.remove("hidden");
            }

            form?.addEventListener("submit", async (e) => {
                e.preventDefault();
                const {
                    data: { session },
                } = await supabase.auth.getSession();
                if (!session) return;

                userId = session.user.id;
                saveBtn.disabled = true;
                saveBtn.textContent = "Guardando...";
                if (msg) msg.classList.add("hidden");

                const formData = new FormData(form);
                const updates = {
                    id: userId,
                    email: session.user.email, // Include email to satisfy NOT NULL constraint
                    first_name: formData.get("first_name"),
                    last_name: formData.get("last_name"),
                    phone: formData.get("phone"),
                    updated_at: new Date().toISOString(),
                };

                const { error } = await supabase.from("users").upsert(updates);

                if (error) {
                    if (msg) {
                        msg.textContent = "Error: " + error.message;
                        msg.className =
                            "text-sm font-medium px-4 py-2 rounded-lg bg-red-50 text-red-600 block";
                        msg.classList.remove("hidden");
                    }
                } else {
                    if (msg) {
                        msg.textContent = "Guardado correctamente";
                        msg.className =
                            "text-sm font-medium px-4 py-2 rounded-lg bg-green-50 text-green-600 block";
                        msg.classList.remove("hidden");
                    }

                    // Update header info if it changed
                    const userNameDisplay =
                        document.getElementById("user-name-display");
                    const userInitials =
                        document.getElementById("user-initials");

                    if (cardNameDisplay)
                        cardNameDisplay.textContent =
                            updates.first_name as string;

                    if (userNameDisplay) {
                        userNameDisplay.textContent =
                            updates.first_name as string;
                    }
                    if (userInitials && updates.first_name) {
                        userInitials.textContent = (
                            updates.first_name as string
                        )
                            .charAt(0)
                            .toUpperCase();
                    }
                }

                saveBtn.disabled = false;
                saveBtn.textContent = "Guardar Cambios";
            });

            loadProfile();
        </script>
    </div>
</Layout>
