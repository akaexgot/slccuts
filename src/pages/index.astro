---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import Gallery from "../components/ui/Gallery.astro";
import Marquee from "../components/ui/Marquee.astro";
import { supabase } from "../lib/supabase";
import ProductCard from "../components/ui/ProductCard.astro";
import MosaicBackground from "../components/ui/MosaicBackground.astro";
import { Image } from "astro:assets";

const cleanUrl = (url: string) => {
	if (url && url.includes("?")) {
		return url.split("?")[0];
	}
	return url;
};

// Fetch gallery images
const { data: galleryImages } = await supabase
	.from("gallery_images")
	.select("*")
	.eq("active", true)
	.order("created_at", { ascending: false });

const { data: rawFeaturedProducts } = await supabase
	.from("products")
	.select(
		"*, product_images(image_url), stock(quantity), category:categories(name, slug)",
	)
	.eq("active", true)
	.eq("is_featured", true)
	.limit(5);

const featuredProducts = (rawFeaturedProducts || []).map((product: any) => ({
	...product,
	image_url: cleanUrl(product.product_images?.[0]?.image_url),
}));

const { data: rawCategories } = await supabase
	.from("categories")
	.select("*")
	.limit(6);

const categories = (rawCategories || []).map((cat: any) => ({
	...cat,
	image_url: cleanUrl(cat.image_url),
}));

const { data: latestNews } = await supabase
	.from("news")
	.select("*")
	.eq("is_published", true)
	.order("created_at", { ascending: false })
	.limit(1);

// Feature settings
const { data: featureSettings } = await supabase
	.from("settings")
	.select("*")
	.in("key", ["feature_gallery_enabled"]);

const galleryEnabled =
	featureSettings?.find((s: any) => s.key === "feature_gallery_enabled")
		?.value ?? true;
---

<Layout title="SLC CUTS | Barbería & Productos">
	<main class="flex-1">
		<!-- Marquee Section (Below Menu) -->
		<Marquee
			phrases={[
				"SLC CUTS",
				"ESTILO CLÁSICO",
				"BARBERÍA MODERNA",
				"PRODUCTOS PREMIUM",
			]}
		/>

		<!-- Hero Section -->
		<div
			class="relative min-h-[80vh] flex items-center justify-center overflow-hidden bg-black animate-on-scroll"
		>
			<!-- Background Image with Overlay -->
			<div class="absolute inset-0 z-0">
				<Image
					src={cleanUrl(
						"https://images.unsplash.com/photo-1585747860715-2ba37e788b70",
					)}
					alt="Barbershop Interior"
					width={1200}
					height={675}
					format="webp"
					class="w-full h-full object-cover opacity-50"
					loading="eager"
					fetchpriority="high"
				/>
				<div
					class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/40 to-black/90"
				>
				</div>
			</div>

			<!-- Hero Content -->
			<div class="relative z-10 text-center text-white px-4 py-20">
				<!-- Using mix-blend-screen to ensure black background is transparent -->
				<div class="animate-on-scroll mb-8">
					<Image
						src="/logoblancotransparente.png"
						alt="SLC CUTS"
						width={250}
						height={250}
						format="webp"
						class="h-32 md:h-48 w-auto mx-auto mix-blend-screen logo-diamond"
						loading="eager"
					/>
				</div>

				<h1
					class="text-5xl md:text-7xl lg:text-9xl mb-4 font-bebas tracking-[0.1em] uppercase animate-on-scroll break-words"
				>
					Maestría & Vanguardia
				</h1>
				<p
					class="text-base md:text-xl text-gray-300 mb-12 font-outfit tracking-[0.2em] md:tracking-[0.3em] font-light uppercase animate-on-scroll max-w-2xl mx-auto"
				>
					Barbería de Autor • Cuidado Premium • Estética sin Límites
				</p>
				<div
					class="flex flex-col md:flex-row gap-4 justify-center animate-on-scroll"
				>
					<a
						href="/services"
						class="bg-white text-black px-12 py-4 uppercase font-bold tracking-[0.2em] hover:bg-gray-200 transition-colors"
					>
						RESERVAR
					</a>
					<a
						href="/shop/new"
						class="border-2 border-white text-white px-8 py-4 uppercase font-bold tracking-widest hover:bg-white hover:text-black transition-colors"
					>
						Tienda Online
					</a>
				</div>
			</div>
		</div>

		{/* About Section - Only show if gallery is enabled */}
		{
			galleryEnabled && (
				<section
					id="about"
					class="py-20 bg-white animate-on-scroll relative overflow-hidden"
				>
					{/* Mosaic Background (Inverted for white theme) */}
					<div
						class="absolute inset-0 opacity-[0.02] pointer-events-none z-0"
						style="background-image: url('/logoblancotransparente.png'); background-size: 100px; background-repeat: repeat; filter: invert(1);"
					/>

					<div class="container mx-auto px-4 relative z-10">
						<div class="flex flex-col md:flex-row items-center gap-12">
							<div
								class={`flex-1 space-y-6 ${!galleryImages || galleryImages.length === 0 ? "w-full md:max-w-4xl mx-auto text-center" : ""}`}
							>
								<h2 class="text-4xl md:text-5xl font-bebas tracking-wider relative inline-block animate-on-scroll">
									La Esencia SLC
									<span class="absolute -bottom-2 left-0 w-full h-1 bg-black" />
								</h2>
								<p class="text-gray-600 text-lg leading-relaxed">
									En SLC CUTS fusionamos la barbería
									tradicional con las tendencias urbanas más
									actuales. Nuestro equipo de expertos no solo
									corta cabello, diseña tu mejor versión.
								</p>
								<p class="text-gray-600 text-lg leading-relaxed">
									Utilizamos y vendemos solo productos de alta
									calidad que garantizan el mejor cuidado para
									tu cabello y barba.
								</p>
							</div>

							{/* Gallery Section (Right side) */}
							{galleryImages && galleryImages.length > 0 && (
								<div class="flex-1 w-full overflow-hidden">
									<Gallery images={galleryImages} />
								</div>
							)}
						</div>
					</div>
				</section>
			)
		}

		<!-- Featured Categories -->
		<section
			class="py-24 bg-black text-white animate-on-scroll relative overflow-hidden"
		>
			<!-- Mosaic Background -->
			<MosaicBackground mode="dark" opacity="opacity-10" />

			<div class="container mx-auto px-4 relative z-10">
				<div class="text-center max-w-3xl mx-auto mb-20">
					<h2
						class="text-xs font-black uppercase tracking-[0.4em] text-white/70 mb-4 font-outfit animate-on-scroll"
					>
						Nuestra Selección
					</h2>
					<h3
						class="text-5xl md:text-8xl font-bebas uppercase tracking-tighter italic animate-on-scroll"
					>
						Explora Nuestra Tienda
					</h3>
				</div>

				<div class="flex flex-wrap justify-center gap-10">
					{
						categories?.map((cat: any) => {
							// Use uploaded image if exists, otherwise fallback to dynamic mapping or default
							let img =
								cat.image_url ||
								"https://images.unsplash.com/photo-1621605815971-fbc98d665033?q=75&w=800&auto=format&fit=crop";

							if (!cat.image_url) {
								if (cat.slug.includes("barba"))
									img =
										"https://images.unsplash.com/photo-1621605815971-fbc98d665033?q=75&w=800&auto=format&fit=crop";
								if (
									cat.slug.includes("pelo") ||
									cat.slug.includes("corte")
								)
									img =
										"https://images.unsplash.com/photo-1599351431202-6e0005a7837f?q=75&w=800&auto=format&fit=crop";
								if (
									cat.slug.includes("capilar") ||
									cat.slug.includes("producto")
								)
									img =
										"https://images.unsplash.com/photo-1556228720-198ed6a4ebbb?q=75&w=800&auto=format&fit=crop";
							}

							return (
								<a
									href={`/shop/${cat.slug}`}
									class="group relative h-[500px] w-full md:w-[calc(50%-2.5rem)] lg:w-[calc(33.333%-2.5rem)] overflow-hidden rounded-[2.5rem] block animate-on-scroll border border-white/5 hover:border-white/20 transition-all duration-700 hover:shadow-2xl hover:shadow-white/5"
								>
									<div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent opacity-60 group-hover:opacity-40 transition-opacity z-10" />
									<Image
										src={img}
										alt={cat.name}
										width={800}
										height={1066}
										format="webp"
										class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-1000 grayscale group-hover:grayscale-0"
									/>
									<div class="absolute inset-0 flex flex-col items-center justify-center z-20 p-8 text-center">
										<h4 class="text-3xl font-black uppercase tracking-tighter italic group-hover:scale-110 transition-transform duration-500 mb-4">
											{cat.name}
										</h4>
										<div class="w-12 h-1 bg-white scale-x-0 group-hover:scale-x-100 transition-transform duration-500 rounded-full" />
									</div>
								</a>
							);
						})
					}
				</div>
			</div>
		</section>

		<section
			class="py-20 bg-gray-100 animate-on-scroll relative overflow-hidden"
		>
			<!-- Mosaic Background (Inverted for light theme) -->
			<div
				class="absolute inset-0 opacity-[0.02] pointer-events-none z-0"
				style="background-image: url('/logoblancotransparente.png'); background-size: 100px; background-repeat: repeat; filter: invert(1);"
			>
			</div>

			<div class="container mx-auto px-4 text-center relative z-10">
				<h2
					class="text-4xl md:text-5xl font-bebas tracking-wider mb-12 animate-on-scroll"
				>
					Productos Destacados
				</h2>
				<div
					class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6"
				>
					{
						(featuredProducts || []).map(
							(product: any, index: number) => (
								<ProductCard
									product={{
										...product,
										image_url:
											product.product_images?.[0]
												?.image_url,
									}}
									loading="lazy"
								/>
							),
						)
					}
				</div>

				<div class="mt-12">
					<a
						href="/shop/new"
						class="text-black border-b-2 border-black pb-1 uppercase tracking-widest font-bold hover:text-gray-600 hover:border-gray-600"
					>
						Ver Todos
					</a>
				</div>
			</div>
		</section>

		<!-- News/Section -->
		{
			latestNews && latestNews.length > 0 && (
				<section class="py-24 bg-white animate-on-scroll relative overflow-hidden">
					<div class="container mx-auto px-4 relative z-10">
						<div class="flex items-center justify-between mb-16 px-4">
							<div class="max-w-xl">
								<h2 class="text-xs font-black uppercase tracking-[0.4em] text-gray-400 mb-4 font-outfit">
									Actualidad SLC
								</h2>
								<h3 class="text-5xl md:text-8xl font-bebas uppercase tracking-tight italic text-black">
									Últimas Noticias
								</h3>
							</div>
							<a
								href="/news"
								class="hidden md:block text-xs font-black uppercase tracking-widest text-black border-b-2 border-black/10 hover:border-black transition-all pb-1"
							>
								Ver todo el blog
							</a>
						</div>

						<div class="space-y-12">
							{latestNews.map((news: any) => (
								<article class="flex flex-col md:flex-row gap-8 md:gap-16 items-center group animate-on-scroll">
									{/* Image - Always Left */}
									<a
										href={`/news/${news.slug}`}
										class="w-full md:w-3/5 aspect-video md:aspect-[21/9] rounded-[2.5rem] overflow-hidden bg-gray-100 block border border-black/5 shadow-2xl relative"
									>
										{news.image_url ? (
											<Image
												src={news.image_url}
												alt={news.title}
												width={1200}
												height={675}
												class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-1000"
											/>
										) : (
											<div class="w-full h-full flex items-center justify-center text-gray-200 text-6xl italic font-black uppercase bg-gray-50">
												SLC
											</div>
										)}
										<div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-colors duration-500" />
									</a>

									{/* Content - Always Right */}
									<div class="w-full md:w-2/5 space-y-8 px-4">
										<div class="flex items-center gap-4">
											<span class="w-12 h-[1px] bg-pink-500" />
											<span class="text-xs font-black uppercase tracking-widest text-pink-500">
												{new Date(
													news.created_at,
												).toLocaleDateString("es-ES", {
													day: "2-digit",
													month: "long",
													year: "numeric",
												})}
											</span>
										</div>
										<h4 class="text-4xl md:text-5xl font-black uppercase tracking-tight italic leading-tight group-hover:text-pink-600 transition-colors">
											<a href={`/news/${news.slug}`}>
												{news.title}
											</a>
										</h4>
										<p class="text-gray-600 text-xl leading-relaxed line-clamp-4 font-medium italic">
											{news.content}
										</p>
										<div class="pt-4">
											<a
												href={`/news/${news.slug}`}
												class="inline-flex items-center gap-4 text-xs font-black uppercase tracking-widest text-black group-hover:gap-6 transition-all border-b-2 border-black/10 pb-1"
											>
												LEER ARTÍCULO COMPLETO{" "}
												<span class="text-xl">→</span>
											</a>
										</div>
									</div>
								</article>
							))}
						</div>

						<div class="mt-16 text-center md:hidden">
							<a
								href="/news"
								class="inline-block text-xs font-black uppercase tracking-widest text-black border-b-2 border-black/10 hover:border-black transition-all pb-1"
							>
								Ver todo el blog
							</a>
						</div>
					</div>
				</section>
			)
		}
	</main>
	<style>
		.logo-diamond {
			transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
			cursor: pointer;
		}
		.logo-diamond:hover {
			transform: perspective(1000px) rotate3d(0, 1, 0, 360deg);
		}
	</style>
</Layout>
