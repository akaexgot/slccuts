---
export const prerender = false;
import ShopLayout from "../../layouts/ShopLayout.astro";
import ProductCard from "../../components/ui/ProductCard.astro";
import { supabase } from "../../lib/supabase";

const url = new URL(Astro.request.url);
const categorySlug = url.searchParams.get("category");
const priceRange = url.searchParams.get("price_range");
const sort = url.searchParams.get("sort") || "newest";

// Build base query
let query = supabase
    .from("products")
    .select(
        "*, product_images(image_url), stock(quantity), category:categories!inner(*)",
    )
    .eq("active", true);

// Filter by category if slug is provided
if (categorySlug) {
    query = query.eq("category.slug", categorySlug);
}

// Filter by price range
if (priceRange) {
    const [min, max] = priceRange.split("-").map(Number);
    if (!isNaN(min)) query = query.gte("price", min * 100);
    if (!isNaN(max)) query = query.lte("price", max * 100);
}

// Handle sorting
if (sort === "price_asc") {
    query = query.order("price", { ascending: true });
} else if (sort === "price_desc") {
    query = query.order("price", { ascending: false });
} else {
    query = query.order("created_at", { ascending: false });
}

const { data: products } = await query.limit(40);
---

<ShopLayout
    title="Nuestros Productos | SLC CUTS"
    description="Explora nuestra colecciÃ³n de productos premium para el cuidado masculino."
>
    <div
        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"
    >
        {
            products && products.length > 0 ? (
                products.map((product: any, index: number) => (
                    <ProductCard
                        product={{
                            ...product,
                            image_url: product.product_images?.[0]?.image_url,
                        }}
                        loading={index < 5 ? "eager" : "lazy"}
                    />
                ))
            ) : (
                <div class="col-span-full py-20 text-center text-gray-500 bg-gray-50 rounded-xl">
                    <p>No hay novedades disponibles en este momento.</p>
                </div>
            )
        }
    </div>
</ShopLayout>
