---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import MosaicBackground from "../components/ui/MosaicBackground.astro";
import { supabase } from "../lib/supabase";
import { Image } from "astro:assets";

// Fetch active gallery images
const { data: images } = await supabase
    .from("gallery_images")
    .select("*")
    .eq("active", true)
    .order("created_at", { ascending: false });
---

<Layout title="Galería de Cortes | SLC CUTS - Barbería en San Lorenzo de el Escorial">
    <!-- SEO Meta -->
    <meta name="description" content="Descubre nuestra galería de cortes de pelo y barbería. Estilos clásicos y modernos en SLC CUTS, tu barbería de confianza en San Lorenzo de el Escorial." slot="head" />
    <meta name="keywords" content="galería cortes pelo, barbería San Lorenzo, cortes modernos, estilos barbería, SLC CUTS" slot="head" />

    <!-- Hero Section -->
    <div class="relative bg-black text-white py-20 px-4 text-center overflow-hidden">
        <MosaicBackground mode="dark" opacity="opacity-10" />
        
        <div class="relative z-10 max-w-3xl mx-auto">
            <h1 class="text-5xl md:text-6xl font-bold uppercase tracking-widest mb-4">
                Galería de Cortes
            </h1>
            <p class="text-gray-400 text-lg md:text-xl max-w-2xl mx-auto">
                Explora nuestros trabajos más recientes. Cada corte cuenta una historia de estilo y precisión.
            </p>
        </div>
    </div>

    <!-- Gallery Section -->
    <div class="bg-white py-16">
        <div class="container mx-auto px-4">
            
            {images && images.length > 0 ? (
                <>
                    <!-- Featured Carousel -->
                    <div class="relative mb-16">
                        <div 
                            id="carousel" 
                            class="flex gap-6 overflow-x-auto snap-x snap-mandatory scroll-smooth pb-6 -mx-4 px-4 scrollbar-hide"
                            style="scrollbar-width: none; -ms-overflow-style: none;"
                        >
                            {images.map((image: any, index: number) => (
                                <div 
                                    class="snap-center shrink-0 first:pl-0 last:pr-0"
                                    style="width: min(85vw, 500px);"
                                >
                                    <div class="group relative aspect-[4/5] rounded-2xl overflow-hidden shadow-2xl">
                                        <Image 
                                            src={image.image_url} 
                                            alt={`Corte de pelo estilo ${index + 1} - SLC CUTS`}
                                            width={500}
                                            height={625}
                                            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                                            loading={index === 0 ? "eager" : "lazy"}
                                        />
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                            <div class="absolute bottom-0 left-0 right-0 p-6 text-white">
                                                <p class="font-bold text-lg">Estilo #{index + 1}</p>
                                                <p class="text-sm text-gray-300">SLC CUTS</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <!-- Navigation Arrows -->
                        <button 
                            id="prevBtn"
                            class="absolute left-2 top-1/2 -translate-y-1/2 w-12 h-12 bg-black/80 hover:bg-black text-white rounded-full flex items-center justify-center shadow-lg transition-all z-10 hidden md:flex"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m15 18-6-6 6-6"/>
                            </svg>
                        </button>
                        <button 
                            id="nextBtn"
                            class="absolute right-2 top-1/2 -translate-y-1/2 w-12 h-12 bg-black/80 hover:bg-black text-white rounded-full flex items-center justify-center shadow-lg transition-all z-10 hidden md:flex"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m9 18 6-6-6-6"/>
                            </svg>
                        </button>

                        <!-- Scroll Indicator (Mobile) -->
                        <div class="flex justify-center gap-2 mt-4 md:hidden">
                            <span class="text-gray-400 text-sm">← Desliza para ver más →</span>
                        </div>
                    </div>

                    <!-- Grid Gallery -->
                    <div class="mb-16">
                        <h2 class="text-3xl font-bold uppercase tracking-wider text-center mb-8">
                            Todos los Estilos
                        </h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {images.map((image: any, index: number) => (
                                <div 
                                    class="group relative aspect-square rounded-xl overflow-hidden cursor-pointer gallery-item"
                                    data-src={image.image_url}
                                    data-index={index}
                                >
                                    <Image 
                                        src={image.image_url} 
                                        alt={`Corte de barbería ${index + 1}`}
                                        width={400}
                                        height={400}
                                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
                                        loading="lazy"
                                    />
                                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-black">
                                                <circle cx="11" cy="11" r="8"/>
                                                <path d="m21 21-4.3-4.3"/>
                                                <path d="M11 8v6"/>
                                                <path d="M8 11h6"/>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </>
            ) : (
                <div class="text-center py-20 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto mb-6 opacity-50">
                        <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
                        <circle cx="9" cy="9" r="2" />
                        <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
                    </svg>
                    <p class="text-xl">Próximamente más fotos</p>
                    <p class="mt-2">Estamos preparando nuestra galería de estilos</p>
                </div>
            )}

            <!-- CTA Section -->
            <div class="text-center">
                <h2 class="text-2xl font-bold uppercase tracking-wider mb-4">
                    ¿Te gusta lo que ves?
                </h2>
                <p class="text-gray-600 mb-8 max-w-xl mx-auto">
                    Reserva tu cita y consigue el estilo que siempre has querido. Nuestros barberos expertos harán realidad tu visión.
                </p>
                <a 
                    href="/services" 
                    class="inline-block bg-black text-white px-10 py-4 uppercase font-bold tracking-widest hover:bg-gray-800 transition-colors"
                >
                    Reservar Cita
                </a>
            </div>
        </div>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-sm">
        <button id="closeLightbox" class="absolute top-6 right-6 text-white p-2 hover:bg-white/10 rounded-full transition-colors z-20">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6 6 18"/>
                <path d="m6 6 12 12"/>
            </svg>
        </button>
        
        <button id="lightboxPrev" class="absolute left-4 top-1/2 -translate-y-1/2 text-white p-3 hover:bg-white/10 rounded-full transition-colors z-20">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m15 18-6-6 6-6"/>
            </svg>
        </button>
        
        <button id="lightboxNext" class="absolute right-4 top-1/2 -translate-y-1/2 text-white p-3 hover:bg-white/10 rounded-full transition-colors z-20">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m9 18 6-6-6-6"/>
            </svg>
        </button>

        <div class="flex items-center justify-center h-full p-4">
            <img id="lightboxImg" src="" alt="" class="max-w-full max-h-full object-contain" />
        </div>
        
        <div class="absolute bottom-6 left-1/2 -translate-x-1/2 text-white text-center">
            <span id="lightboxCounter" class="text-sm opacity-70"></span>
        </div>
    </div>
</Layout>

<style>
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
</style>

<script>
    // Carousel Navigation
    const carousel = document.getElementById('carousel');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const scrollAmount = 520;

    prevBtn?.addEventListener('click', () => {
        carousel?.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    });

    nextBtn?.addEventListener('click', () => {
        carousel?.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    });

    // Lightbox
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg') as HTMLImageElement;
    const lightboxCounter = document.getElementById('lightboxCounter');
    const closeLightbox = document.getElementById('closeLightbox');
    const lightboxPrev = document.getElementById('lightboxPrev');
    const lightboxNext = document.getElementById('lightboxNext');
    const galleryItems = document.querySelectorAll('.gallery-item');
    
    let currentIndex = 0;
    const images: string[] = [];
    
    galleryItems.forEach((item, index) => {
        const src = (item as HTMLElement).dataset.src;
        if (src) images.push(src);
        
        item.addEventListener('click', () => {
            currentIndex = index;
            openLightbox();
        });
    });

    function openLightbox() {
        if (!lightbox || !lightboxImg) return;
        lightboxImg.src = images[currentIndex];
        if (lightboxCounter) {
            lightboxCounter.textContent = `${currentIndex + 1} / ${images.length}`;
        }
        lightbox.classList.remove('hidden');
        lightbox.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }

    function closeLightboxFn() {
        lightbox?.classList.add('hidden');
        lightbox?.classList.remove('flex');
        document.body.style.overflow = '';
    }

    function showPrev() {
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        openLightbox();
    }

    function showNext() {
        currentIndex = (currentIndex + 1) % images.length;
        openLightbox();
    }

    closeLightbox?.addEventListener('click', closeLightboxFn);
    lightboxPrev?.addEventListener('click', showPrev);
    lightboxNext?.addEventListener('click', showNext);

    lightbox?.addEventListener('click', (e) => {
        if (e.target === lightbox) closeLightboxFn();
    });

    document.addEventListener('keydown', (e) => {
        if (!lightbox?.classList.contains('hidden')) {
            if (e.key === 'Escape') closeLightboxFn();
            if (e.key === 'ArrowLeft') showPrev();
            if (e.key === 'ArrowRight') showNext();
        }
    });

    // Touch swipe for lightbox
    let touchStartX = 0;
    lightbox?.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
    });

    lightbox?.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartX - touchEndX;
        if (Math.abs(diff) > 50) {
            if (diff > 0) showNext();
            else showPrev();
        }
    });
</script>
